{% extends "base.html" %} {% block title %}Today's Route{% endblock %} {% block
content %}
<div class="max-w-4xl mx-auto space-y-8">
    <!-- Header -->
    <header>
        <div class="flex items-center justify-between mb-2">
            <h1 class="text-3xl font-bold">Today's Route</h1>

            <div class="flex gap-3">
                <button
                    onclick="openAddCustomerModal()"
                    class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition flex items-center gap-2"
                >
                    <svg
                        class="w-4 h-4"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M12 4v16m8-8H4"
                        />
                    </svg>
                    Add Stop
                </button>

                {% if stops %}
                <button
                    onclick="toggleSelectMode()"
                    class="text-sm text-gray-400 hover:text-blue-400 transition px-4 py-2"
                >
                    <span id="selectModeText">Select Multiple</span>
                </button>
                {% endif %}
            </div>
        </div>

        <p class="text-gray-400">{{ today.strftime("%A, %B %d") }}</p>
    </header>

    {% if not stops %}
    <!-- Empty State -->
    <section
        class="bg-gray-900 border border-gray-800 rounded-2xl text-center p-12"
    >
        <div class="text-5xl mb-4">üìç</div>
        <h2 class="text-2xl font-semibold mb-3">No route yet</h2>
        <p class="text-gray-400 mb-6">
            Your route for today is empty. Start by adding customers.
        </p>
        <button
            onclick="openAddCustomerModal()"
            class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium transition"
        >
            + Add Customers
        </button>
        <p class="text-sm text-gray-500 mt-6">
            Search and select customers to build today's plan.
        </p>
    </section>

    {% else %} {% set completed = stops | selectattr("completed") | list %} {%
    set remaining = stops | rejectattr("completed") | list %} {% set total =
    stops | length %} {% set done = completed | length %} {% set progress_pct =
    (done / total * 100) if total > 0 else 0 %}

    <!-- Progress -->
    <section
        class="bg-gradient-to-br from-blue-600 to-blue-700 rounded-2xl p-6 shadow-lg"
    >
        <div class="flex items-center justify-between">
            <div>
                <p class="text-white/80 text-sm font-medium mb-1">Progress</p>
                <p class="text-4xl font-bold text-white">
                    {{ done }} / {{ total }}
                </p>
                <p class="text-white/70 text-sm">stops completed</p>
            </div>
            <div class="text-5xl font-bold text-white/20">
                {{ progress_pct | round | int }}%
            </div>
        </div>

        <div class="mt-4 bg-white/20 rounded-full h-2 overflow-hidden">
            <div
                class="bg-white h-full rounded-full transition-all duration-500"
                style="width: {{ progress_pct | round }}%"
            ></div>
        </div>
    </section>

    <!-- Bulk Actions -->
    <div
        id="bulkActions"
        class="hidden bg-gray-900 border border-gray-800 rounded-xl p-4 flex items-center justify-between"
    >
        <span class="text-sm text-gray-400">
            <span id="selectedCount">0</span> selected
        </span>
        <div class="flex gap-2">
            <button
                onclick="bulkComplete()"
                class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition"
            >
                Complete Selected
            </button>
            <button
                onclick="bulkRemove()"
                class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition"
            >
                Remove Selected
            </button>
            <button
                onclick="cancelSelect()"
                class="bg-gray-800 hover:bg-gray-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition"
            >
                Cancel
            </button>
        </div>
    </div>

    <!-- Remaining Stops -->
    <section>
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-semibold">Remaining Stops</h2>
            <span class="text-sm text-gray-400">
                {{ remaining | length }} stop{{ 's' if remaining | length != 1
                else '' }}
            </span>
        </div>

        {% if remaining %}
        <ul class="space-y-3" id="stopsList">
            {% for stop in remaining %}
            <li
                class="bg-gray-900 border border-gray-800 rounded-xl p-5 group relative hover:border-gray-700 transition"
                data-stop-id="{{ stop.stop_id }}"
            >
                {% if stop.customer_balance and stop.customer_balance > 0 %}
                <div
                    class="absolute -top-2 -right-2 bg-red-500 text-white text-xs px-2 py-1 rounded-full font-medium shadow-lg"
                >
                    ${{ (stop.customer_balance / 100) | round(2) }}
                </div>
                {% endif %}

                <div class="flex gap-4">
                    <button
                        class="drag-handle opacity-0 group-hover:opacity-100 text-gray-500 hover:text-gray-300 transition cursor-move"
                    >
                        ‚ò∞
                    </button>

                    <input type="checkbox" class="stop-checkbox hidden mt-1" />

                    <div class="flex-1">
                        <div class="flex justify-between gap-4 flex-wrap">
                            <div class="flex-1 min-w-0">
                                <h3 class="text-lg font-medium mb-1">
                                    {{ stop.name }}
                                </h3>

                                {% if stop.customer_address %}
                                <a
                                    href="https://www.google.com/maps/search/?api=1&query={{ stop.customer_address | urlencode }}"
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    class="text-sm text-blue-400 hover:text-blue-300 flex items-center gap-1 mb-1"
                                >
                                    <svg
                                        class="w-4 h-4"
                                        fill="none"
                                        stroke="currentColor"
                                        viewBox="0 0 24 24"
                                    >
                                        <path
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            stroke-width="2"
                                            d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"
                                        />
                                        <path
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            stroke-width="2"
                                            d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"
                                        />
                                    </svg>
                                    {{ stop.customer_address }}
                                </a>
                                {% endif %} {% if stop.customer_phone %}
                                <a
                                    href="tel:{{ stop.customer_phone }}"
                                    class="text-sm text-blue-400 hover:text-blue-300 flex items-center gap-1"
                                >
                                    <svg
                                        class="w-4 h-4"
                                        fill="none"
                                        stroke="currentColor"
                                        viewBox="0 0 24 24"
                                    >
                                        <path
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            stroke-width="2"
                                            d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"
                                        />
                                    </svg>
                                    {{ stop.customer_phone }}
                                </a>
                                {% endif %}
                            </div>

                            <div class="flex gap-2 stop-actions">
                                <form
                                    method="post"
                                    action="{{ url_for('route.route_complete', stop_id=stop.stop_id) }}"
                                >
                                    <button
                                        type="submit"
                                        class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition"
                                    >
                                        Complete
                                    </button>
                                </form>

                                <button
                                    onclick="toggleNotes(this)"
                                    class="bg-gray-800 hover:bg-gray-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition"
                                >
                                    Notes
                                </button>

                                <form
                                    method="post"
                                    action="{{ url_for('route.route_remove', stop_id=stop.stop_id) }}"
                                >
                                    <button
                                        type="submit"
                                        class="text-red-400 hover:text-red-300 px-2 transition"
                                        onclick="
                                            return confirm('Remove this stop?');
                                        "
                                        aria-label="Remove stop"
                                    >
                                        ‚úï
                                    </button>
                                </form>
                            </div>
                        </div>

                        <div
                            class="notes-section hidden mt-4 border-t border-gray-800 pt-4"
                        >
                            <form
                                method="post"
                                action="{{ url_for('route.route_update_notes', stop_id=stop.stop_id) }}"
                            >
                                <textarea
                                    name="notes"
                                    rows="3"
                                    class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-3 focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
                                    placeholder="Add notes for this stop‚Ä¶"
                                >
{{ stop.notes or "" }}</textarea
                                >
                                <button
                                    type="submit"
                                    class="mt-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition"
                                >
                                    Save Notes
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </li>
            {% endfor %}
        </ul>
        {% else %}
        <div
            class="bg-gray-900 border border-gray-800 rounded-xl text-center p-12"
        >
            <div class="text-5xl mb-4">üéâ</div>
            <h3 class="text-xl font-semibold mb-2">All Done!</h3>
            <p class="text-gray-400">
                No remaining stops ‚Äî you're done for today!
            </p>
        </div>
        {% endif %}
    </section>

    <!-- Completed -->
    {% if completed %}
    <section>
        <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
            <svg
                class="w-5 h-5 text-green-400"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
            >
                <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M5 13l4 4L19 7"
                />
            </svg>
            Completed ({{ completed | length }})
        </h2>
        <ul class="space-y-2">
            {% for stop in completed %}
            <li
                class="bg-gray-900/50 border border-gray-800 rounded-lg px-5 py-3 flex items-center gap-3 opacity-60"
            >
                <svg
                    class="w-5 h-5 text-green-400 shrink-0"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M5 13l4 4L19 7"
                    />
                </svg>
                <span class="line-through flex-1">{{ stop.name }}</span>
                {% if stop.completed_at %}
                <span class="text-xs text-gray-500">
                    {{ stop.completed_at.strftime("%I:%M %p") }}
                </span>
                {% endif %}
            </li>
            {% endfor %}
        </ul>
    </section>
    {% endif %} {% endif %}
</div>

<!-- Add Customer Modal - Note: This references a missing partial template -->
<!-- You'll need to create route/_add_customer_modal.html or implement the modal here -->
<div
    id="addCustomerModal"
    class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4"
>
    <div
        class="bg-gray-900 border border-gray-800 rounded-2xl p-8 max-w-md w-full"
    >
        <h3 class="text-xl font-semibold mb-6">Add Customer to Route</h3>
        <form method="post" action="{{ url_for('route.route_add') }}">
            <div class="mb-4">
                <label class="block text-sm text-gray-400 mb-2">Customer</label>
                <select
                    name="customer_id"
                    required
                    class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2.5 focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
                >
                    <option value="">Select customer‚Ä¶</option>
                    <!-- You'll need to pass customers to this template -->
                </select>
            </div>
            <div class="flex gap-3">
                <button
                    type="button"
                    onclick="closeAddCustomerModal()"
                    class="flex-1 bg-gray-800 hover:bg-gray-700 text-white px-4 py-2.5 rounded-lg font-medium transition"
                >
                    Cancel
                </button>
                <button
                    class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2.5 rounded-lg font-medium transition"
                >
                    Add to Route
                </button>
            </div>
        </form>
    </div>
</div>

{% endblock %} {% block scripts %}
<script>
    // Toggle notes section
    function toggleNotes(button) {
        const li = button.closest("li");
        const notesSection = li.querySelector(".notes-section");
        notesSection.classList.toggle("hidden");
    }

    // Modal functions
    function openAddCustomerModal() {
        document.getElementById("addCustomerModal").classList.remove("hidden");
    }

    function closeAddCustomerModal() {
        document.getElementById("addCustomerModal").classList.add("hidden");
    }

    // Select mode for bulk actions
    let selectMode = false;

    function toggleSelectMode() {
        selectMode = !selectMode;
        const checkboxes = document.querySelectorAll(".stop-checkbox");
        const actions = document.querySelectorAll(".stop-actions");
        const bulkActions = document.getElementById("bulkActions");
        const modeText = document.getElementById("selectModeText");

        checkboxes.forEach((cb) => cb.classList.toggle("hidden"));
        actions.forEach((a) => a.classList.toggle("hidden"));

        if (selectMode) {
            bulkActions.classList.remove("hidden");
            modeText.textContent = "Cancel Select";
        } else {
            bulkActions.classList.add("hidden");
            modeText.textContent = "Select Multiple";
            checkboxes.forEach((cb) => (cb.checked = false));
            updateSelectedCount();
        }
    }

    function cancelSelect() {
        toggleSelectMode();
    }

    function updateSelectedCount() {
        const checked = document.querySelectorAll(
            ".stop-checkbox:checked",
        ).length;
        document.getElementById("selectedCount").textContent = checked;
    }

    // Listen for checkbox changes
    document.addEventListener("change", (e) => {
        if (e.target.classList.contains("stop-checkbox")) {
            updateSelectedCount();
        }
    });

    function bulkComplete() {
        const selected = [
            ...document.querySelectorAll(".stop-checkbox:checked"),
        ].map((cb) => cb.closest("li").dataset.stopId);

        if (selected.length === 0) {
            alert("No stops selected");
            return;
        }

        if (confirm(`Complete ${selected.length} stop(s)?`)) {
            // Implement bulk complete - you'll need to add a backend endpoint
            console.log("Complete stops:", selected);
        }
    }

    function bulkRemove() {
        const selected = [
            ...document.querySelectorAll(".stop-checkbox:checked"),
        ].map((cb) => cb.closest("li").dataset.stopId);

        if (selected.length === 0) {
            alert("No stops selected");
            return;
        }

        if (confirm(`Remove ${selected.length} stop(s)?`)) {
            // Implement bulk remove - you'll need to add a backend endpoint
            console.log("Remove stops:", selected);
        }
    }

    // Close modal on escape
    document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
            closeAddCustomerModal();
        }
    });
</script>
{% endblock %}
