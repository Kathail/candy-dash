{% extends "base.html" %} {% block title %}Route{% endblock %} {% block content
%}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 lg:py-10 space-y-8">
    <!-- Header -->
    <div
        class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 flex-wrap"
    >
        <div>
            <h1 class="text-2xl sm:text-3xl font-bold text-white">
                Today's Route
            </h1>
            <p class="mt-1 text-sm text-gray-400">
                {{ today.strftime("%A, %B %d, %Y") }}
            </p>
        </div>

        <div class="flex items-center gap-3 flex-wrap">
            <button
                onclick="openAddCustomerModal()"
                class="inline-flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-5 py-2.5 rounded-lg text-sm font-medium transition shadow-sm"
            >
                <svg
                    class="w-4 h-4"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                    stroke-width="2"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        d="M12 4v16m8-8H4"
                    />
                </svg>
                Add Stop
            </button>

            {% if stops %}
            <button
                onclick="toggleSelectMode()"
                class="text-sm font-medium text-gray-300 hover:text-blue-400 px-4 py-2 transition"
            >
                <span id="selectModeText">Select</span>
            </button>
            {% endif %}
        </div>
    </div>

    {% if not stops %}

    <!-- Empty State -->
    <div
        class="bg-gray-800 border border-gray-700 rounded-xl text-center py-16 px-6"
    >
        <div class="text-6xl mb-4">üìç</div>
        <h2 class="text-xl font-semibold text-white mb-3">
            No stops scheduled today
        </h2>
        <p class="text-gray-400 mb-6 max-w-md mx-auto">
            Add customers to plan your route and start tracking visits.
        </p>
        <button
            onclick="openAddCustomerModal()"
            class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium transition shadow-md"
        >
            Add First Stop
        </button>
    </div>

    {% else %} {% set completed = stops | selectattr("completed") | list %} {%
    set remaining = stops | rejectattr("completed") | list %} {% set total =
    stops | length %} {% set done = completed | length %} {% set pct = (done /
    total * 100) | round(0) if total > 0 else 0 %}

    <!-- Progress Card -->
    <div class="bg-gray-800 border border-gray-700 rounded-xl p-6 shadow-sm">
        <div
            class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-4"
        >
            <div>
                <p
                    class="text-xs font-medium text-gray-400 uppercase tracking-wide"
                >
                    Today's Progress
                </p>
                <p class="text-xl sm:text-2xl font-bold text-white mt-1">
                    {{ done }} / {{ total }} stops completed
                </p>
            </div>
            <div class="text-2xl sm:text-3xl font-bold text-blue-400">
                {{ pct }}%
            </div>
        </div>
        <div class="bg-gray-700 rounded-full h-2.5 overflow-hidden">
            <div
                class="bg-blue-600 h-full transition-all duration-700 ease-out"
                style="width: {{ pct }}%"
            ></div>
        </div>
    </div>

    <!-- Bulk Actions Bar -->
    <div
        id="bulkActions"
        class="hidden sticky top-4 z-20 bg-gray-950 border border-gray-700 rounded-xl px-5 py-4 shadow-lg flex flex-col sm:flex-row sm:items-center justify-between gap-4 transition-all duration-200"
    >
        <span class="text-sm font-medium text-gray-300">
            <span id="selectedCount" class="text-white">0</span> selected
        </span>
        <div class="flex flex-wrap gap-2">
            <button
                onclick="bulkComplete()"
                class="bg-green-600 hover:bg-green-700 text-white px-5 py-2.5 rounded-lg text-sm font-medium transition"
            >
                Complete Selected
            </button>
            <button
                onclick="bulkRemove()"
                class="bg-red-600 hover:bg-red-700 text-white px-5 py-2.5 rounded-lg text-sm font-medium transition"
            >
                Remove Selected
            </button>
            <button
                onclick="cancelSelect()"
                class="bg-gray-700 hover:bg-gray-600 text-white px-5 py-2.5 rounded-lg text-sm font-medium transition"
            >
                Cancel
            </button>
        </div>
    </div>

    <!-- Remaining Stops -->
    <section class="space-y-4">
        <div class="flex items-center justify-between">
            <h2 class="text-lg font-semibold text-white">Remaining Stops</h2>
            <span class="text-sm text-gray-400">{{ remaining|length }}</span>
        </div>

        {% if remaining %}
        <div class="space-y-3" id="stopsList">
            {% for stop in remaining %}
            <div
                class="bg-gray-800 border border-gray-700 rounded-xl p-4 hover:border-gray-500 transition-all group"
                data-stop-id="{{ stop.stop_id }}"
            >
                <div class="flex items-start gap-4">
                    <input
                        type="checkbox"
                        class="stop-checkbox hidden h-5 w-5 mt-1 rounded border-gray-600 text-blue-500 focus:ring-blue-500 bg-gray-700"
                    />

                    <div class="flex-1 min-w-0">
                        <div
                            class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-3"
                        >
                            <div class="min-w-0">
                                <h3 class="font-medium text-gray-100 truncate">
                                    {{ stop.name }}
                                </h3>
                                {% if stop.customer_address %}
                                <a
                                    href="https://www.google.com/maps/search/?api=1&query={{ stop.customer_address | urlencode }}"
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    class="text-xs text-blue-400 hover:text-blue-300 hover:underline mt-0.5 inline-block"
                                >
                                    {{ stop.customer_address }}
                                </a>
                                {% endif %}
                            </div>

                            <div
                                class="flex items-center gap-2 stop-actions shrink-0"
                            >
                                <form
                                    method="post"
                                    action="{{ url_for('route.route_complete', stop_id=stop.stop_id) }}"
                                >
                                    <button
                                        type="submit"
                                        class="bg-green-600/90 hover:bg-green-700 text-white text-xs font-medium px-4 py-2 rounded-lg transition"
                                    >
                                        Complete
                                    </button>
                                </form>

                                <button
                                    onclick="toggleNotes(this)"
                                    class="bg-gray-700 hover:bg-gray-600 text-white text-xs font-medium px-4 py-2 rounded-lg transition"
                                >
                                    Notes
                                </button>

                                <form
                                    method="post"
                                    action="{{ url_for('route.route_remove', stop_id=stop.stop_id) }}"
                                >
                                    <button
                                        type="submit"
                                        onclick="
                                            return confirm(
                                                'Remove this stop from today‚Äôs route?',
                                            );
                                        "
                                        class="text-red-400 hover:text-red-300 text-xl font-bold px-2 transition"
                                    >
                                        √ó
                                    </button>
                                </form>
                            </div>
                        </div>

                        <!-- Notes -->
                        <div
                            class="notes-section hidden mt-4 pt-4 border-t border-gray-700 transition-all duration-200"
                        >
                            <form
                                method="post"
                                action="{{ url_for('route.route_update_notes', stop_id=stop.stop_id) }}"
                            >
                                <textarea
                                    name="notes"
                                    rows="3"
                                    class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2.5 text-sm text-gray-100 placeholder-gray-500 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none resize-y"
                                >
{{ stop.notes or "" }}</textarea
                                >
                                <div class="mt-3 flex justify-end">
                                    <button
                                        type="submit"
                                        class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded-lg text-sm font-medium transition"
                                    >
                                        Save Notes
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div
            class="bg-gray-800/70 border border-gray-700 rounded-xl p-10 text-center"
        >
            <p class="text-lg text-gray-300">All stops completed today üéâ</p>
        </div>
        {% endif %}
    </section>

    <!-- Completed Stops -->
    {% if completed %}
    <section class="pt-4">
        <h2 class="text-sm font-semibold text-gray-400 mb-3">
            Completed ({{ completed|length }})
        </h2>
        <ul class="space-y-1.5 text-sm">
            {% for stop in completed %}
            <li class="text-gray-500 line-through flex items-center gap-2 px-1">
                <span class="text-green-400">‚úì</span>
                <span class="truncate">{{ stop.name }}</span>
            </li>
            {% endfor %}
        </ul>
    </section>
    {% endif %} {% endif %}
</div>
{% endblock %} {% block scripts %}
<script>
    function toggleNotes(btn) {
        const section = btn.closest(".min-w-0").querySelector(".notes-section");
        section.classList.toggle("hidden");
    }

    let selectMode = false;

    function toggleSelectMode() {
        selectMode = !selectMode;
        document
            .querySelectorAll(".stop-checkbox")
            .forEach((el) => el.classList.toggle("hidden", !selectMode));
        document
            .querySelectorAll(".stop-actions")
            .forEach((el) => el.classList.toggle("hidden", selectMode));
        document
            .getElementById("bulkActions")
            ?.classList.toggle("hidden", !selectMode);
        document.getElementById("selectModeText").textContent = selectMode
            ? "Cancel"
            : "Select";
        if (!selectMode) {
            document
                .querySelectorAll(".stop-checkbox")
                .forEach((chk) => (chk.checked = false));
            updateSelectedCount();
        }
    }

    function cancelSelect() {
        toggleSelectMode();
    }

    function updateSelectedCount() {
        const count = document.querySelectorAll(
            ".stop-checkbox:checked",
        ).length;
        document.getElementById("selectedCount").textContent = count;
    }

    document.addEventListener("change", (e) => {
        if (e.target.classList.contains("stop-checkbox")) {
            updateSelectedCount();
        }
    });

    function bulkComplete() {
        // TODO: collect checked stop IDs ‚Üí POST to bulk-complete endpoint
        alert("Bulk complete ‚Äì implement backend call here");
    }

    function bulkRemove() {
        // TODO: collect checked stop IDs ‚Üí POST to bulk-remove endpoint
        alert("Bulk remove ‚Äì implement backend call here");
    }

    // Optional: close notes when clicking outside (nice UX)
    document.addEventListener("click", (e) => {
        if (
            !e.target.closest(".notes-section") &&
            !e.target.closest('button[onclick*="toggleNotes"]')
        ) {
            document
                .querySelectorAll(".notes-section:not(.hidden)")
                .forEach((el) => el.classList.add("hidden"));
        }
    });
</script>
{% endblock %}
