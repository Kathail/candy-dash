{% extends "base.html" %} {% block title %}Today's Route{% endblock %} {% block
content %}

<div class="max-w-4xl mx-auto space-y-8">
    <!-- Header -->
    <header>
        <div class="flex items-center justify-between mb-2">
            <h1 class="text-3xl font-bold">Today's Route</h1>

            <div class="flex gap-3">
                <button
                    onclick="openAddCustomerModal()"
                    class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition flex items-center gap-2"
                >
                    <svg
                        class="w-4 h-4"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M12 4v16m8-8H4"
                        />
                    </svg>
                    Add Stop
                </button>

                {% if stops %}
                <button
                    onclick="toggleSelectMode()"
                    class="text-sm text-gray-400 hover:text-blue-400 transition px-4 py-2"
                >
                    <span id="selectModeText">Select Multiple</span>
                </button>
                {% endif %}
            </div>
        </div>

        <p class="text-gray-400">{{ today.strftime("%A, %B %d") }}</p>
    </header>

    {% if not stops %}
    <!-- Empty State -->
    <section class="card text-center p-12">
        <div class="text-5xl mb-4">üìç</div>
        <h2 class="text-2xl font-semibold mb-3">No route yet</h2>
        <p class="text-gray-400 mb-6">
            Your route for today is empty. Start by adding customers.
        </p>
        <button
            onclick="openAddCustomerModal()"
            class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium transition"
        >
            + Add Customers
        </button>
        <p class="text-sm text-gray-500 mt-6">
            Search and select customers to build today‚Äôs plan.
        </p>
    </section>

    {% else %} {% set completed = stops | selectattr("completed") | list %} {%
    set remaining = stops | rejectattr("completed") | list %} {% set total =
    stops | length %} {% set done = completed | length %} {% set progress_pct =
    (done / total * 100) if total > 0 else 0 %}

    <!-- Progress -->
    <section
        class="bg-gradient-to-br from-blue-600 to-blue-700 rounded-2xl p-6 shadow-lg"
    >
        <div class="flex items-center justify-between">
            <div>
                <p class="text-white/80 text-sm font-medium mb-1">Progress</p>
                <p class="text-4xl font-bold text-white">
                    {{ done }} / {{ total }}
                </p>
                <p class="text-white/70 text-sm">stops completed</p>
            </div>
            <div class="text-5xl font-bold text-white/20">
                {{ progress_pct | round | int }}%
            </div>
        </div>

        <div class="mt-4 bg-white/20 rounded-full h-2 overflow-hidden">
            <div
                class="bg-white h-full rounded-full transition-all duration-500"
                style="width: {{ progress_pct | round }}%"
            ></div>
        </div>
    </section>

    <!-- Bulk Actions -->
    <div id="bulkActions" class="hidden card flex items-center justify-between">
        <span class="text-sm text-gray-400">
            <span id="selectedCount">0</span> selected
        </span>
        <div class="flex gap-2">
            <button onclick="bulkComplete()" class="btn-success">
                Complete Selected
            </button>
            <button onclick="bulkRemove()" class="btn-danger">
                Remove Selected
            </button>
            <button onclick="cancelSelect()" class="btn-secondary">
                Cancel
            </button>
        </div>
    </div>

    <!-- Remaining Stops -->
    <section>
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-semibold">Remaining Stops</h2>
            <span class="text-sm text-gray-400">
                {{ remaining | length }} stop{{ 's' if remaining | length != 1
                }}
            </span>
        </div>

        {% if remaining %}
        <ul class="space-y-3" id="stopsList">
            {% for stop in remaining %}
            <li
                class="card p-5 group relative"
                data-stop-id="{{ stop.stop_id }}"
            >
                {% if stop.customer_balance and stop.customer_balance > 0 %}
                <div class="absolute -top-2 -right-2 badge-owing">
                    ${{ (stop.customer_balance / 100) | round(2) }}
                </div>
                {% endif %}

                <div class="flex gap-4">
                    <button
                        class="drag-handle opacity-0 group-hover:opacity-100"
                    >
                        ‚ò∞
                    </button>

                    <input type="checkbox" class="stop-checkbox hidden mt-1" />

                    <div class="flex-1">
                        <div class="flex justify-between gap-4">
                            <div>
                                <h3 class="text-lg font-medium">
                                    {{ stop.name }}
                                </h3>

                                {% if stop.customer_address %}
                                <a
                                    href="https://www.google.com/maps/search/?api=1&query={{ stop.customer_address | urlencode }}"
                                    target="_blank"
                                    class="text-sm text-blue-400 hover:text-blue-300"
                                >
                                    {{ stop.customer_address }}
                                </a>
                                {% endif %} {% if stop.customer_phone %}
                                <a
                                    href="tel:{{ stop.customer_phone }}"
                                    class="block text-sm text-blue-400 hover:text-blue-300"
                                >
                                    {{ stop.customer_phone }}
                                </a>
                                {% endif %}
                            </div>

                            <div class="flex gap-2 stop-actions">
                                <form
                                    method="post"
                                    action="{{ url_for('route.route_complete', stop_id=stop.stop_id) }}"
                                >
                                    <button type="submit" class="btn-success">
                                        Complete
                                    </button>
                                </form>

                                <button
                                    onclick="toggleNotes(this)"
                                    class="btn-secondary"
                                >
                                    Notes
                                </button>

                                <form
                                    method="post"
                                    action="{{ url_for('route.route_remove', stop_id=stop.stop_id) }}"
                                >
                                    <button
                                        type="submit"
                                        class="icon-danger"
                                        onclick="
                                            return confirm('Remove this stop?');
                                        "
                                    >
                                        ‚úï
                                    </button>
                                </form>
                            </div>
                        </div>

                        <div
                            class="notes-section hidden mt-4 border-t border-gray-800 pt-4"
                        >
                            <form
                                method="post"
                                action="{{ url_for('route.route_update_notes', stop_id=stop.stop_id) }}"
                            >
                                <textarea
                                    name="notes"
                                    rows="3"
                                    class="textarea"
                                    placeholder="Add notes for this stop‚Ä¶"
                                >
{{ stop.notes or "" }}</textarea
                                >
                                <button type="submit" class="btn-primary mt-2">
                                    Save Notes
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </li>
            {% endfor %}
        </ul>
        {% else %}
        <div class="card text-center p-8">
            üéâ No remaining stops ‚Äî you‚Äôre done for today!
        </div>
        {% endif %}
    </section>

    <!-- Completed -->
    {% if completed %}
    <section>
        <h2 class="text-xl font-semibold mb-4">Completed</h2>
        <ul class="space-y-2">
            {% for stop in completed %}
            <li class="card opacity-60 flex items-center gap-3">
                ‚úì <span class="line-through">{{ stop.name }}</span>
                {% if stop.completed_at %}
                <span class="ml-auto text-xs text-gray-500">
                    {{ stop.completed_at.strftime("%I:%M %p") }}
                </span>
                {% endif %}
            </li>
            {% endfor %}
        </ul>
    </section>
    {% endif %} {% endif %}
</div>

<!-- Add Customer Modal -->
{% include "route/_add_customer_modal.html" %} {% endblock %}
