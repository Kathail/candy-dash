{% extends "base.html" %} {% block title %}Today's Route{% endblock %} {% block
content %}
<div class="max-w-5xl mx-auto space-y-6">
    <!-- Header -->
    <header class="flex items-start justify-between">
        <div>
            <h1 class="text-2xl font-semibold">Today's Route</h1>
            <p class="text-sm text-gray-400">
                {{ today.strftime("%A, %B %d") }}
            </p>
        </div>

        <div class="flex gap-2">
            <button
                onclick="openAddCustomerModal()"
                class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-lg text-sm font-medium transition flex items-center gap-2"
            >
                <svg
                    class="w-4 h-4"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M12 4v16m8-8H4"
                    />
                </svg>
                Add Stop
            </button>

            {% if stops %}
            <button
                onclick="toggleSelectMode()"
                class="text-sm text-gray-400 hover:text-blue-400 transition px-3 py-2"
            >
                <span id="selectModeText">Select</span>
            </button>
            {% endif %}
        </div>
    </header>

    {% if not stops %}
    <!-- Empty State -->
    <section
        class="bg-gray-900 border border-gray-800 rounded-xl text-center p-10"
    >
        <div class="text-4xl mb-3">üìç</div>
        <h2 class="text-lg font-semibold mb-2">No stops yet</h2>
        <p class="text-gray-400 mb-5 text-sm">
            Add customers to build today‚Äôs route.
        </p>
        <button
            onclick="openAddCustomerModal()"
            class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2.5 rounded-lg text-sm font-medium transition"
        >
            Add Customers
        </button>
    </section>

    {% else %} {% set completed = stops | selectattr("completed") | list %} {%
    set remaining = stops | rejectattr("completed") | list %} {% set total =
    stops | length %} {% set done = completed | length %} {% set progress_pct =
    (done / total * 100) if total > 0 else 0 %}

    <!-- Progress (dashboard style) -->
    <section class="bg-gray-900 border border-gray-800 rounded-xl p-4">
        <div class="flex items-center justify-between mb-2">
            <div>
                <p class="text-xs text-gray-400">Progress</p>
                <p class="text-lg font-semibold">
                    {{ done }} / {{ total }} completed
                </p>
            </div>
            <div class="text-sm text-gray-400">
                {{ progress_pct | round | int }}%
            </div>
        </div>

        <div class="bg-gray-800 rounded-full h-2 overflow-hidden">
            <div
                class="bg-blue-600 h-full transition-all"
                style="width: {{ progress_pct | round }}%"
            ></div>
        </div>
    </section>

    <!-- Bulk Actions -->
    <div
        id="bulkActions"
        class="hidden bg-gray-900 border border-gray-800 rounded-xl p-3 flex items-center justify-between"
    >
        <span class="text-sm text-gray-400">
            <span id="selectedCount">0</span> selected
        </span>
        <div class="flex gap-2">
            <button
                onclick="bulkComplete()"
                class="bg-green-600 hover:bg-green-700 text-white px-3 py-1.5 rounded-lg text-sm"
            >
                Complete
            </button>
            <button
                onclick="bulkRemove()"
                class="bg-red-600 hover:bg-red-700 text-white px-3 py-1.5 rounded-lg text-sm"
            >
                Remove
            </button>
            <button
                onclick="cancelSelect()"
                class="bg-gray-800 hover:bg-gray-700 text-white px-3 py-1.5 rounded-lg text-sm"
            >
                Cancel
            </button>
        </div>
    </div>

    <!-- Remaining Stops -->
    <section>
        <div class="flex items-center justify-between mb-3">
            <h2 class="text-lg font-semibold">Remaining</h2>
            <span class="text-sm text-gray-400">
                {{ remaining | length }}
            </span>
        </div>

        {% if remaining %}
        <ul class="space-y-2" id="stopsList">
            {% for stop in remaining %}
            <li
                class="bg-gray-900 border border-gray-800 rounded-lg p-4 hover:border-gray-700 transition"
                data-stop-id="{{ stop.stop_id }}"
            >
                <div class="flex gap-3 items-start">
                    <input type="checkbox" class="stop-checkbox hidden mt-1" />

                    <div class="flex-1 min-w-0">
                        <div class="flex justify-between gap-3">
                            <div>
                                <h3 class="text-sm font-medium truncate">
                                    {{ stop.name }}
                                </h3>

                                {% if stop.customer_address %}
                                <a
                                    href="https://www.google.com/maps/search/?api=1&query={{ stop.customer_address | urlencode }}"
                                    target="_blank"
                                    class="text-xs text-blue-400 hover:text-blue-300"
                                >
                                    {{ stop.customer_address }}
                                </a>
                                {% endif %}
                            </div>

                            <div class="flex gap-2 stop-actions">
                                <form
                                    method="post"
                                    action="{{ url_for('route.route_complete', stop_id=stop.stop_id) }}"
                                >
                                    <button
                                        class="bg-green-600 hover:bg-green-700 text-white px-3 py-1.5 rounded-lg text-xs"
                                    >
                                        Complete
                                    </button>
                                </form>

                                <button
                                    onclick="toggleNotes(this)"
                                    class="bg-gray-800 hover:bg-gray-700 text-white px-3 py-1.5 rounded-lg text-xs"
                                >
                                    Notes
                                </button>

                                <form
                                    method="post"
                                    action="{{ url_for('route.route_remove', stop_id=stop.stop_id) }}"
                                >
                                    <button
                                        class="text-red-400 hover:text-red-300 px-2 text-sm"
                                        onclick="
                                            return confirm('Remove this stop?');
                                        "
                                    >
                                        ‚úï
                                    </button>
                                </form>
                            </div>
                        </div>

                        <div
                            class="notes-section hidden mt-3 border-t border-gray-800 pt-3"
                        >
                            <form
                                method="post"
                                action="{{ url_for('route.route_update_notes', stop_id=stop.stop_id) }}"
                            >
                                <textarea
                                    name="notes"
                                    rows="2"
                                    class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm"
                                >
{{ stop.notes or "" }}</textarea
                                >
                                <button
                                    class="mt-2 bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 rounded-lg text-xs"
                                >
                                    Save Notes
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </li>
            {% endfor %}
        </ul>
        {% else %}
        <div
            class="bg-gray-900 border border-gray-800 rounded-xl text-center p-8"
        >
            <p class="text-gray-400 text-sm">All stops completed üéâ</p>
        </div>
        {% endif %}
    </section>

    <!-- Completed -->
    {% if completed %}
    <section>
        <h2 class="text-sm font-semibold text-gray-400 mb-2">
            Completed ({{ completed | length }})
        </h2>
        <ul class="space-y-1">
            {% for stop in completed %}
            <li class="text-sm text-gray-500 line-through px-1">
                {{ stop.name }}
            </li>
            {% endfor %}
        </ul>
    </section>
    {% endif %} {% endif %}
</div>
{% endblock %} {% block scripts %}
<script>
    function toggleNotes(button) {
        button
            .closest("li")
            .querySelector(".notes-section")
            .classList.toggle("hidden");
    }

    let selectMode = false;

    function toggleSelectMode() {
        selectMode = !selectMode;
        document
            .querySelectorAll(".stop-checkbox")
            .forEach((cb) => cb.classList.toggle("hidden"));
        document
            .querySelectorAll(".stop-actions")
            .forEach((a) => a.classList.toggle("hidden"));
        document.getElementById("bulkActions").classList.toggle("hidden");
        document.getElementById("selectModeText").textContent = selectMode
            ? "Cancel"
            : "Select";
    }

    function cancelSelect() {
        toggleSelectMode();
    }

    function updateSelectedCount() {
        document.getElementById("selectedCount").textContent =
            document.querySelectorAll(".stop-checkbox:checked").length;
    }

    document.addEventListener("change", (e) => {
        if (e.target.classList.contains("stop-checkbox")) updateSelectedCount();
    });

    function bulkComplete() {
        alert("Bulk complete requires backend endpoint.");
    }

    function bulkRemove() {
        alert("Bulk remove requires backend endpoint.");
    }
</script>
{% endblock %}
