{% extends "base.html" %} {% block title %}Customers{% endblock %} {% block
content %}
<div class="max-w-7xl mx-auto space-y-6">
    <!-- Header -->
    <header
        class="flex items-start sm:items-center justify-between gap-4 flex-wrap"
    >
        <div>
            <h1 class="text-2xl sm:text-3xl font-bold">Customers</h1>
            <p class="text-sm text-gray-400 mt-1">
                Manage customers and balances
            </p>
        </div>

        <div class="flex items-center gap-2 w-full sm:w-auto">
            <button
                type="button"
                data-action="scroll-add"
                class="w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-gray-950"
            >
                + Add Customer
            </button>
        </div>
    </header>

    <!-- Stats -->
    {% set owing = customers | selectattr('balance_cents', 'gt', 0) | list %} {%
    set total_owed = owing | sum(attribute='balance_cents') %}

    <section class="grid grid-cols-1 sm:grid-cols-3 gap-4">
        <div class="bg-gray-900 border border-gray-800 rounded-xl p-5">
            <p class="text-xs text-gray-400 mb-1">Total Customers</p>
            <p class="text-2xl sm:text-3xl font-bold">
                {{ customers | length }}
            </p>
        </div>

        <div class="bg-gray-900 border border-gray-800 rounded-xl p-5">
            <p class="text-xs text-gray-400 mb-1">Total Owed</p>
            <p class="text-2xl sm:text-3xl font-bold text-red-400">
                ${{ (total_owed / 100) | round(2) }}
            </p>
        </div>

        <div class="bg-gray-900 border border-gray-800 rounded-xl p-5">
            <p class="text-xs text-gray-400 mb-1">Customers Owing</p>
            <p class="text-2xl sm:text-3xl font-bold text-amber-400">
                {{ owing | length }}
            </p>
        </div>
    </section>

    <!-- Bulk Action Bar (UI-only, unified behavior) -->
    <div
        id="bulk-bar"
        class="hidden sticky top-0 z-20 bg-gray-950 border border-gray-800 rounded-xl px-3 py-2.5 flex items-center justify-between gap-3"
    >
        <div class="text-sm text-gray-300">
            <span id="selected-count">0</span> selected
        </div>
        <div class="flex flex-wrap gap-2 justify-end">
            <!-- UI-only: wire backend later if you want -->
            <button
                type="button"
                class="bg-blue-600 hover:bg-blue-700 text-white text-xs sm:text-sm rounded-lg px-3 py-2"
                id="bulk-add-to-route"
                title="(UI only) Send selection to Calendar"
            >
                Add to Route
            </button>

            <button
                type="button"
                class="bg-gray-800 hover:bg-gray-700 text-white text-xs sm:text-sm rounded-lg px-3 py-2"
                id="bulk-clear"
            >
                Clear
            </button>
        </div>
    </div>

    <!-- Customer Table -->
    <section
        class="bg-gray-900 border border-gray-800 rounded-2xl overflow-hidden"
    >
        <header
            class="p-4 sm:p-6 border-b border-gray-800 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3"
        >
            <div class="flex items-baseline gap-2">
                <h2 class="text-lg sm:text-xl font-semibold">Customer List</h2>
                <span class="text-xs text-gray-500"
                    >({{ customers | length }})</span
                >
            </div>

            <div
                class="w-full sm:w-auto flex flex-col sm:flex-row gap-2 sm:items-center"
            >
                <div class="relative w-full sm:w-72">
                    <input
                        id="customer-search"
                        type="search"
                        placeholder="Search name, phone, address…"
                        class="w-full bg-gray-800 border border-gray-700 rounded-lg pl-10 pr-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
                    />
                    <svg
                        class="w-4 h-4 text-gray-500 absolute left-3 top-1/2 -translate-y-1/2"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M21 21l-4.35-4.35M10.5 18a7.5 7.5 0 110-15 7.5 7.5 0 010 15z"
                        />
                    </svg>
                </div>

                <div class="flex gap-2">
                    <button
                        type="button"
                        id="toggle-density"
                        class="bg-gray-800 hover:bg-gray-700 text-white text-xs sm:text-sm rounded-lg px-3 py-2 transition"
                        title="Toggle compact rows (mobile-friendly)"
                    >
                        Compact
                    </button>

                    <button
                        type="button"
                        id="toggle-select"
                        class="bg-gray-800 hover:bg-gray-700 text-white text-xs sm:text-sm rounded-lg px-3 py-2 transition"
                        title="Select multiple rows"
                    >
                        Select
                    </button>
                </div>
            </div>

            <p id="search-meta" class="text-xs text-gray-500 hidden"></p>
        </header>

        {% if customers %}
        <div class="overflow-x-auto">
            <table class="w-full text-sm" id="customer-table">
                <thead
                    class="bg-gray-950 text-gray-400 uppercase text-[11px] border-b border-gray-800 sticky top-0 z-10"
                >
                    <tr>
                        <th class="px-4 sm:px-6 py-3 w-10 text-left">
                            <input
                                type="checkbox"
                                id="select-all"
                                class="hidden accent-blue-500"
                            />
                        </th>

                        <th
                            class="sortable px-2 sm:px-6 py-3 text-left cursor-pointer hover:text-blue-400 transition"
                            data-key="name"
                        >
                            <span class="inline-flex items-center gap-2">
                                Name
                                <span
                                    class="sort-indicator text-xs opacity-70"
                                    data-indicator-for="name"
                                    >—</span
                                >
                            </span>
                        </th>

                        <th
                            class="sortable px-2 sm:px-6 py-3 text-left cursor-pointer hover:text-blue-400 transition hidden lg:table-cell"
                            data-key="phone"
                        >
                            <span class="inline-flex items-center gap-2">
                                Phone
                                <span
                                    class="sort-indicator text-xs opacity-70"
                                    data-indicator-for="phone"
                                    >—</span
                                >
                            </span>
                        </th>

                        <th
                            class="px-2 sm:px-6 py-3 text-left hidden xl:table-cell"
                        >
                            Address
                        </th>

                        <th
                            class="sortable px-2 sm:px-6 py-3 text-right cursor-pointer hover:text-blue-400 transition"
                            data-key="balance"
                            data-sort-default="desc"
                        >
                            <span
                                class="inline-flex items-center justify-end gap-2 w-full"
                            >
                                Balance
                                <span
                                    class="sort-indicator text-xs opacity-70"
                                    data-indicator-for="balance"
                                    >↓</span
                                >
                            </span>
                        </th>

                        <th
                            class="sortable px-2 sm:px-6 py-3 text-left cursor-pointer hover:text-blue-400 transition hidden md:table-cell"
                            data-key="lastvisit"
                        >
                            <span class="inline-flex items-center gap-2">
                                Last Visit
                                <span
                                    class="sort-indicator text-xs opacity-70"
                                    data-indicator-for="lastvisit"
                                    >—</span
                                >
                            </span>
                        </th>

                        <th class="px-2 sm:px-6 py-3 text-right">Actions</th>
                    </tr>
                </thead>

                <tbody id="customer-body" class="divide-y divide-gray-800">
                    {% for c in customers %} {% set bal = (c.balance_cents /
                    100) %}
                    <tr
                        class="customer-row hover:bg-gray-900/50 transition {% if c.balance_cents > 0 %}bg-red-900/10{% endif %}"
                        data-id="{{ c.id }}"
                        data-name="{{ c.name | lower }}"
                        data-phone="{{ c.phone or '' }}"
                        data-balance="{{ c.balance_cents }}"
                        data-lastvisit="{{ c.last_visit_at.isoformat() if c.last_visit_at else '1900-01-01' }}"
                        data-search="{{ (c.name ~ ' ' ~ (c.phone or '') ~ ' ' ~ (c.address or '') ) | lower }}"
                    >
                        <!-- Select -->
                        <td class="px-4 sm:px-6 py-3 align-top">
                            <input
                                type="checkbox"
                                class="row-check hidden accent-blue-500 mt-1"
                            />
                        </td>

                        <!-- Name + mobile meta -->
                        <td class="px-2 sm:px-6 py-3 align-top">
                            <button
                                type="button"
                                class="font-medium text-gray-100 hover:text-blue-400 hover:underline transition btn-edit focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-gray-950 rounded"
                                data-id="{{ c.id }}"
                                data-name="{{ c.name }}"
                                data-phone="{{ c.phone or '' }}"
                                data-address="{{ c.address or '' }}"
                                data-balance="{{ (c.balance_cents / 100) | round(2) }}"
                            >
                                {{ c.name }}
                            </button>

                            <!-- Mobile meta -->
                            <div
                                class="mt-1 text-xs text-gray-500 space-y-1 lg:hidden"
                            >
                                <div class="flex flex-wrap gap-x-3 gap-y-1">
                                    <span>
                                        <span class="text-gray-600"
                                            >Phone:</span
                                        >
                                        <span class="text-gray-400"
                                            >{{ c.phone or '—' }}</span
                                        >
                                    </span>

                                    <span class="md:hidden">
                                        <span class="text-gray-600">Last:</span>
                                        <span class="text-gray-400">
                                            {% if c.last_visit_at %}{{
                                            c.last_visit_at.strftime('%b %d,
                                            %Y') }}{% else %}Never{% endif %}
                                        </span>
                                    </span>
                                </div>

                                {% if c.address %}
                                <div class="truncate">
                                    <span class="text-gray-600">Addr:</span>
                                    <span class="text-gray-400"
                                        >{{ c.address }}</span
                                    >
                                </div>
                                {% endif %}
                            </div>
                        </td>

                        <!-- Phone (desktop) -->
                        <td
                            class="px-2 sm:px-6 py-3 text-gray-400 hidden lg:table-cell align-top"
                        >
                            {{ c.phone or '—' }}
                        </td>

                        <!-- Address (desktop) -->
                        <td
                            class="px-2 sm:px-6 py-3 text-gray-400 hidden xl:table-cell align-top"
                        >
                            {{ c.address or '—' }}
                        </td>

                        <!-- Balance -->
                        <td class="px-2 sm:px-6 py-3 text-right align-top">
                            {% if c.balance_cents > 0 %} {% if bal < 20 %} {%
                            set bal_color = "text-yellow-300" %} {% elif bal <
                            100 %} {% set bal_color = "text-orange-400" %} {%
                            else %} {% set bal_color = "text-red-400" %} {%
                            endif %}
                            <span class="{{ bal_color }} font-semibold">
                                ${{ bal | round(2) }}
                            </span>
                            {% else %}
                            <span class="text-gray-400">$0.00</span>
                            {% endif %}
                        </td>

                        <!-- Last visit (desktop) -->
                        <td
                            class="px-2 sm:px-6 py-3 text-gray-400 hidden md:table-cell align-top"
                        >
                            {% if c.last_visit_at %} {{
                            c.last_visit_at.strftime('%b %d, %Y') }} {% else %}
                            Never {% endif %}
                        </td>

                        <!-- Actions -->
                        <td class="px-2 sm:px-6 py-3 text-right align-top">
                            <div class="inline-flex items-center gap-2">
                                <button
                                    class="bg-gray-800/60 hover:bg-gray-700 text-white text-xs px-3 py-1.5 rounded-lg transition btn-edit focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-gray-950"
                                    data-id="{{ c.id }}"
                                    data-name="{{ c.name }}"
                                    data-phone="{{ c.phone or '' }}"
                                    data-address="{{ c.address or '' }}"
                                    data-balance="{{ (c.balance_cents / 100) | round(2) }}"
                                >
                                    Edit
                                </button>

                                <form
                                    method="post"
                                    action="{{ url_for('customers.customer_delete', customer_id=c.id) }}"
                                    class="inline"
                                    onsubmit="return confirm('Delete {{ c.name }}?');"
                                >
                                    <button
                                        type="submit"
                                        class="bg-red-600/20 hover:bg-red-600 text-red-300 hover:text-white text-xs px-3 py-1.5 rounded-lg transition focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 focus:ring-offset-gray-950"
                                    >
                                        Delete
                                    </button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

            <p id="no-results" class="hidden text-center text-gray-500 py-10">
                No customers match your search.
            </p>
        </div>
        {% else %}
        <div class="p-12 text-center text-gray-500">
            <svg
                class="w-14 h-14 mx-auto mb-4 opacity-50"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
            >
                <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0 2 2 0 014 0z"
                />
            </svg>
            <p>No customers yet.</p>
        </div>
        {% endif %}
    </section>

    <!-- Add Customer -->
    <section
        id="add-form"
        class="bg-gray-900 border border-gray-800 rounded-2xl p-5 sm:p-8"
    >
        <h2 class="text-lg sm:text-xl font-semibold mb-5">Add New Customer</h2>

        <form
            method="post"
            action="{{ url_for('customers.customer_add') }}"
            class="grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-6"
        >
            <div>
                <label class="block text-sm text-gray-400 mb-2">Name *</label>
                <input
                    name="name"
                    required
                    class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2.5 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
                />
            </div>

            <div>
                <label class="block text-sm text-gray-400 mb-2">Phone</label>
                <input
                    name="phone"
                    class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2.5 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
                />
            </div>

            <div class="md:col-span-2">
                <label class="block text-sm text-gray-400 mb-2">Address</label>
                <input
                    name="address"
                    class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2.5 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
                />
            </div>

            <div>
                <label class="block text-sm text-gray-400 mb-2"
                    >Starting Balance ($)</label
                >
                <input
                    name="balance"
                    type="number"
                    step="0.01"
                    value="0.00"
                    class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2.5 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
                />
            </div>

            <div class="md:col-span-2 flex justify-end">
                <button
                    class="w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white px-6 py-2.5 rounded-lg text-sm font-medium transition focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-gray-950"
                >
                    Add Customer
                </button>
            </div>
        </form>
    </section>
</div>

<!-- Edit Modal -->
<div
    id="edit-modal"
    class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4"
>
    <div
        class="bg-gray-900 border border-gray-800 rounded-2xl p-6 sm:p-8 max-w-md w-full"
    >
        <h3 class="text-lg sm:text-xl font-semibold mb-5">Edit Customer</h3>

        <form id="edit-form" method="post" class="space-y-4">
            <input type="hidden" name="customer_id" />

            <div>
                <label class="block text-sm text-gray-400 mb-2">Name</label>
                <input
                    name="name"
                    required
                    class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2.5 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
                />
            </div>

            <div>
                <label class="block text-sm text-gray-400 mb-2">Phone</label>
                <input
                    name="phone"
                    class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2.5 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
                />
            </div>

            <div>
                <label class="block text-sm text-gray-400 mb-2">Address</label>
                <input
                    name="address"
                    class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2.5 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
                />
            </div>

            <div>
                <label class="block text-sm text-gray-400 mb-2"
                    >Balance ($)</label
                >
                <input
                    name="balance"
                    type="number"
                    step="0.01"
                    class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2.5 text-sm font-semibold focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
                />
            </div>

            <div class="flex gap-3 pt-2">
                <button
                    type="button"
                    data-action="close"
                    class="flex-1 bg-gray-800 hover:bg-gray-700 text-white px-4 py-2.5 rounded-lg text-sm font-medium transition focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-gray-950"
                >
                    Cancel
                </button>
                <button
                    class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2.5 rounded-lg text-sm font-medium transition focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-gray-950"
                >
                    Save Changes
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %} {% block scripts %}
<script>
    (() => {
        const rows = [...document.querySelectorAll(".customer-row")];
        const search = document.getElementById("customer-search");
        const tableBody = document.getElementById("customer-body");
        const modal = document.getElementById("edit-modal");
        const form = document.getElementById("edit-form");

        const meta = document.getElementById("search-meta");
        const noResults = document.getElementById("no-results");

        // unified controls
        const toggleSelectBtn = document.getElementById("toggle-select");
        const bulkBar = document.getElementById("bulk-bar");
        const selectedCountEl = document.getElementById("selected-count");
        const selectAll = document.getElementById("select-all");

        const toggleDensityBtn = document.getElementById("toggle-density");

        // Sorting state (unified with balances: default by balance severity desc)
        let sort = { key: "balance", dir: -1 }; // -1 = desc, 1 = asc
        let selectMode = false;
        let compactMode = false;

        // Scroll to add form
        document
            .querySelector('[data-action="scroll-add"]')
            ?.addEventListener("click", () => {
                document
                    .getElementById("add-form")
                    ?.scrollIntoView({ behavior: "smooth", block: "start" });
            });

        // --- Search (fast, consistent) ---
        function applySearch() {
            const q = (search?.value || "").trim().toLowerCase();
            let visible = 0;

            rows.forEach((r) => {
                const hay = (r.dataset.search || r.textContent).toLowerCase();
                const show = !q || hay.includes(q);
                r.style.display = show ? "" : "none";
                if (show) visible++;
            });

            if (meta) {
                meta.textContent = q ? `${visible} result(s)` : "";
                meta.classList.toggle("hidden", !q);
            }
            if (noResults) {
                noResults.classList.toggle("hidden", !(q && visible === 0));
            }
        }
        search?.addEventListener("input", applySearch);

        // --- Sorting (with visible state) ---
        function setIndicators(activeKey) {
            document
                .querySelectorAll("[data-indicator-for]")
                .forEach((el) => (el.textContent = "—"));
            document
                .querySelectorAll("[data-key]")
                .forEach((th) => th.classList.remove("text-blue-400"));

            const activeTh = document.querySelector(
                `[data-key="${activeKey}"]`,
            );
            activeTh?.classList.add("text-blue-400");

            const ind = document.querySelector(
                `[data-indicator-for="${activeKey}"]`,
            );
            if (ind) ind.textContent = sort.dir === -1 ? "↓" : "↑";
        }

        function compare(a, b) {
            const key = sort.key;
            let A = a.dataset[key] ?? "";
            let B = b.dataset[key] ?? "";

            const nA = Number(A);
            const nB = Number(B);
            const isNum =
                !Number.isNaN(nA) && !Number.isNaN(nB) && A !== "" && B !== "";

            if (isNum) return sort.dir * (nA - nB);
            return sort.dir * String(A).localeCompare(String(B));
        }

        function applySort() {
            // keep only visible rows order-in-place for smooth UX
            const visible = rows.filter((r) => r.style.display !== "none");
            const hidden = rows.filter((r) => r.style.display === "none");

            visible.sort(compare);
            [...visible, ...hidden].forEach((r) => tableBody.appendChild(r));
            setIndicators(sort.key);
        }

        document.querySelectorAll("[data-key]").forEach((th) => {
            th.addEventListener("click", () => {
                const key = th.dataset.key;
                sort.dir =
                    sort.key === key
                        ? -sort.dir
                        : th.dataset.sortDefault === "desc"
                          ? -1
                          : 1;
                sort.key = key;
                applySort();
            });
        });

        // Default sort by balance severity (desc) like balances page
        setIndicators("balance");
        applySort();

        // --- Edit modal ---
        document.querySelectorAll(".btn-edit").forEach((btn) => {
            btn.addEventListener("click", () => {
                form.action =
                    "{{ url_for('customers.customer_edit', customer_id=0) }}".replace(
                        "0",
                        btn.dataset.id,
                    );

                form.customer_id.value = btn.dataset.id;
                form.name.value = btn.dataset.name;
                form.phone.value = btn.dataset.phone;
                form.address.value = btn.dataset.address;
                form.balance.value = btn.dataset.balance;

                modal.classList.remove("hidden");
            });
        });

        function closeModal() {
            modal.classList.add("hidden");
        }
        document
            .querySelectorAll('[data-action="close"]')
            .forEach((btn) => btn.addEventListener("click", closeModal));
        document.addEventListener("keydown", (e) => {
            if (e.key === "Escape") closeModal();
        });
        modal?.addEventListener("click", (e) => {
            if (e.target === modal) closeModal();
        });

        // --- Select mode / bulk (unified with balances behavior) ---
        const rowChecks = () => [...document.querySelectorAll(".row-check")];

        function updateBulkBar() {
            const count = rowChecks().filter((c) => c.checked).length;
            selectedCountEl.textContent = count;
            bulkBar.classList.toggle("hidden", count === 0);
            if (selectAll) {
                const checks = rowChecks();
                const any = checks.some((c) => c.checked);
                const all = checks.length && checks.every((c) => c.checked);
                selectAll.indeterminate = any && !all;
                selectAll.checked = all;
            }
        }

        function setSelectMode(on) {
            selectMode = on;
            // show/hide checkboxes
            rowChecks().forEach((cb) =>
                cb.classList.toggle("hidden", !selectMode),
            );
            // show/hide select-all
            selectAll?.classList.toggle("hidden", !selectMode);

            toggleSelectBtn.textContent = selectMode ? "Done" : "Select";

            if (!selectMode) {
                rowChecks().forEach((cb) => (cb.checked = false));
                updateBulkBar();
            }
        }

        toggleSelectBtn?.addEventListener("click", () =>
            setSelectMode(!selectMode),
        );

        selectAll?.addEventListener("change", (e) => {
            rowChecks().forEach((cb) => {
                if (cb.closest("tr").style.display !== "none")
                    cb.checked = e.target.checked;
            });
            updateBulkBar();
        });

        document.addEventListener("change", (e) => {
            if (e.target.classList.contains("row-check")) updateBulkBar();
        });

        document.getElementById("bulk-clear")?.addEventListener("click", () => {
            rowChecks().forEach((cb) => (cb.checked = false));
            updateBulkBar();
        });

        // UI-only: send selected to calendar prefill (same scheme as balances)
        document
            .getElementById("bulk-add-to-route")
            ?.addEventListener("click", () => {
                const ids = rowChecks()
                    .filter((cb) => cb.checked)
                    .map((cb) => cb.closest("tr")?.dataset.id)
                    .filter(Boolean);

                if (!ids.length) return;

                const params = new URLSearchParams();
                ids.forEach((id) => params.append("customers", id));
                window.location.href = `/calendar?${params.toString()}`;
            });

        // --- Density toggle (mobile-first without breaking desktop) ---
        function applyDensity() {
            compactMode = !compactMode;
            toggleDensityBtn.textContent = compactMode ? "Comfort" : "Compact";

            // compact reduces paddings a touch by toggling classes on rows/cells
            rows.forEach((r) => {
                r.querySelectorAll("td").forEach((td) => {
                    td.classList.toggle("py-3", !compactMode);
                    td.classList.toggle("py-2", compactMode);
                });
            });
        }
        // initialize td paddings to match our template (py-3 already set); keep toggle safe
        toggleDensityBtn?.addEventListener("click", applyDensity);

        // Start in mobile-friendly select mode OFF, compact OFF
        setSelectMode(false);
        applySearch(); // respects any browser autofill
    })();
</script>

<style>
    /* Subtle row hover accent for quicker scanning */
    .customer-row:hover {
        box-shadow: inset 3px 0 0 0 rgb(59 130 246 / 0.55);
    }
</style>
{% endblock %}
