{% extends "base.html" %} {% block title %}Customers{% endblock %} {% block
content %}
<div class="max-w-7xl mx-auto space-y-8">
    <!-- Header -->
    <header
        class="flex flex-wrap items-start sm:items-center justify-between gap-4"
    >
        <div>
            <h1 class="text-2xl sm:text-3xl font-bold">Customers</h1>
            <p class="text-sm text-gray-400 mt-1">
                Manage customers and balances
            </p>
        </div>

        <button
            type="button"
            data-action="scroll-add"
            class="w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-gray-950"
        >
            + Add Customer
        </button>
    </header>

    <!-- Stats -->
    {% set owing = customers | selectattr('balance_cents', 'gt', 0) | list %} {%
    set total_owed = owing | sum(attribute='balance_cents') %}

    <section class="grid grid-cols-1 sm:grid-cols-3 gap-4">
        <div class="bg-gray-900 border border-gray-800 rounded-xl p-5">
            <p class="text-xs text-gray-400 mb-1">Total Customers</p>
            <p class="text-2xl sm:text-3xl font-bold">
                {{ customers | length }}
            </p>
        </div>

        <div class="bg-gray-900 border border-gray-800 rounded-xl p-5">
            <p class="text-xs text-gray-400 mb-1">Total Owed</p>
            <p class="text-2xl sm:text-3xl font-bold text-red-400">
                ${{ (total_owed / 100) | round(2) }}
            </p>
        </div>

        <div class="bg-gray-900 border border-gray-800 rounded-xl p-5">
            <p class="text-xs text-gray-400 mb-1">Customers Owing</p>
            <p class="text-2xl sm:text-3xl font-bold text-amber-400">
                {{ owing | length }}
            </p>
        </div>
    </section>

    <!-- Bulk Action Bar -->
    <div
        id="bulk-bar"
        class="hidden sticky top-0 z-20 bg-gray-950 border border-gray-800 rounded-xl px-4 py-3 flex items-center justify-between gap-3"
    >
        <span class="text-sm text-gray-300">
            <span id="selected-count">0</span> selected
        </span>
        <div class="flex flex-wrap gap-2 justify-end">
            <button
                type="button"
                id="bulk-add-to-route"
                class="bg-blue-600 hover:bg-blue-700 text-white text-xs sm:text-sm rounded-lg px-3 py-2"
            >
                Add to Route
            </button>
            <button
                type="button"
                id="bulk-clear"
                class="bg-gray-800 hover:bg-gray-700 text-white text-xs sm:text-sm rounded-lg px-3 py-2"
            >
                Clear
            </button>
        </div>
    </div>

    <!-- Customer Table -->
    <section
        class="bg-gray-900 border border-gray-800 rounded-2xl overflow-hidden"
    >
        <header
            class="p-4 sm:p-6 border-b border-gray-800 flex flex-col sm:flex-row gap-3 sm:items-center sm:justify-between"
        >
            <div class="flex items-baseline gap-2">
                <h2 class="text-lg sm:text-xl font-semibold">Customer List</h2>
                <span class="text-xs text-gray-500"
                    >({{ customers | length }})</span
                >
            </div>

            <div
                class="flex flex-col sm:flex-row gap-2 sm:items-center w-full sm:w-auto"
            >
                <div class="relative w-full sm:w-72">
                    <input
                        id="customer-search"
                        type="search"
                        placeholder="Search name, phone, address…"
                        class="w-full bg-gray-800 border border-gray-700 rounded-lg pl-10 pr-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
                    />
                    <svg
                        class="w-4 h-4 text-gray-500 absolute left-3 top-1/2 -translate-y-1/2"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M21 21l-4.35-4.35M10.5 18a7.5 7.5 0 110-15 7.5 7.5 0 010 15z"
                        />
                    </svg>
                </div>

                <div class="flex gap-2">
                    <button
                        id="toggle-density"
                        class="bg-gray-800 hover:bg-gray-700 text-white text-xs sm:text-sm rounded-lg px-3 py-2"
                    >
                        Compact
                    </button>
                    <button
                        id="toggle-select"
                        class="bg-gray-800 hover:bg-gray-700 text-white text-xs sm:text-sm rounded-lg px-3 py-2"
                    >
                        Select
                    </button>
                </div>
            </div>

            <p id="search-meta" class="text-xs text-gray-500 hidden"></p>
        </header>

        {% if customers %}
        <div class="overflow-x-auto">
            <table class="w-full text-sm" id="customer-table">
                <thead
                    class="bg-gray-950 text-gray-400 uppercase text-[11px] border-b border-gray-800 sticky top-0 z-10"
                >
                    <tr>
                        <th class="px-4 sm:px-6 py-3 w-10">
                            <input
                                id="select-all"
                                type="checkbox"
                                class="hidden accent-blue-500"
                            />
                        </th>
                        <th
                            class="sortable px-2 sm:px-6 py-3 text-left cursor-pointer"
                            data-key="name"
                        >
                            Name
                            <span
                                data-indicator-for="name"
                                class="sort-indicator opacity-70"
                                >—</span
                            >
                        </th>
                        <th
                            class="sortable px-2 sm:px-6 py-3 text-right cursor-pointer"
                            data-key="balance"
                            data-sort-default="desc"
                        >
                            Balance
                            <span
                                data-indicator-for="balance"
                                class="sort-indicator opacity-70"
                                >↓</span
                            >
                        </th>
                        <th class="px-2 sm:px-6 py-3 text-right">Actions</th>
                    </tr>
                </thead>

                <tbody id="customer-body" class="divide-y divide-gray-800">
                    {% for c in customers %}
                    <tr
                        class="customer-row hover:bg-gray-900/50 transition"
                        data-id="{{ c.id }}"
                        data-name="{{ c.name | lower }}"
                        data-balance="{{ c.balance_cents }}"
                        data-search="{{ (c.name ~ ' ' ~ (c.phone or '') ~ ' ' ~ (c.address or '')) | lower }}"
                    >
                        <td class="px-4 sm:px-6 py-3">
                            <input
                                type="checkbox"
                                class="row-check hidden accent-blue-500"
                            />
                        </td>

                        <td class="px-2 sm:px-6 py-3">
                            <span class="font-medium text-gray-100"
                                >{{ c.name }}</span
                            >
                        </td>

                        <td class="px-2 sm:px-6 py-3 text-right">
                            {% if c.balance_cents > 0 %}
                            <span class="text-red-400 font-semibold">
                                ${{ (c.balance_cents / 100) | round(2) }}
                            </span>
                            {% else %}
                            <span class="text-gray-400">$0.00</span>
                            {% endif %}
                        </td>

                        <td class="px-2 sm:px-6 py-3 text-right">
                            <a
                                href="#"
                                class="text-blue-400 hover:underline text-xs"
                                >Edit</a
                            >
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

            <p id="no-results" class="hidden text-center text-gray-500 py-10">
                No customers match your search.
            </p>
        </div>
        {% endif %}
    </section>
</div>
{% endblock %} {% block scripts %}
<script>
    (() => {
        const rows = [...document.querySelectorAll(".customer-row")];
        const search = document.getElementById("customer-search");
        const tableBody = document.getElementById("customer-body");
        const bulkBar = document.getElementById("bulk-bar");
        const selectedCountEl = document.getElementById("selected-count");
        const toggleSelectBtn = document.getElementById("toggle-select");
        const selectAll = document.getElementById("select-all");

        let sort = { key: "balance", dir: -1 };
        let selectMode = false;

        function applySearch() {
            const q = (search.value || "").toLowerCase();
            let visible = 0;
            rows.forEach((r) => {
                const show = !q || r.dataset.search.includes(q);
                r.style.display = show ? "" : "none";
                if (show) visible++;
            });
            document
                .getElementById("no-results")
                .classList.toggle("hidden", visible !== 0 || !q);
        }

        function applySort() {
            const visible = rows.filter((r) => r.style.display !== "none");
            visible.sort(
                (a, b) =>
                    sort.dir * (a.dataset[sort.key] - b.dataset[sort.key]),
            );
            visible.forEach((r) => tableBody.appendChild(r));
        }

        search.addEventListener("input", () => {
            applySearch();
            applySort();
        });

        toggleSelectBtn.addEventListener("click", () => {
            selectMode = !selectMode;
            document
                .querySelectorAll(".row-check")
                .forEach((cb) => cb.classList.toggle("hidden", !selectMode));
            selectAll.classList.toggle("hidden", !selectMode);
            toggleSelectBtn.textContent = selectMode ? "Done" : "Select";
            if (!selectMode) {
                document
                    .querySelectorAll(".row-check")
                    .forEach((cb) => (cb.checked = false));
                bulkBar.classList.add("hidden");
            }
        });
    })();
</script>
{% endblock %}
