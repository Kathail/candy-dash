{% extends "base.html" %} {% block title %}Customers{% endblock %} {% block
content %}

<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 space-y-8">
    <!-- Header -->
    <header class="flex items-center justify-between">
        <div>
            <h1 class="text-3xl font-bold">Customers</h1>
            <p class="text-gray-400 mt-1">Manage customers and balances</p>
        </div>

        <button type="button" data-action="scroll-add" class="btn-primary">
            + Add Customer
        </button>
    </header>

    <!-- Stats -->
    {% set owing = customers | selectattr('balance_cents', 'gt', 0) | list %} {%
    set total_owed = owing | sum(attribute='balance_cents') %}

    <section class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="card-muted">
            <p class="card-label">Total Customers</p>
            <p class="card-value">{{ customers | length }}</p>
        </div>

        <div class="card-muted">
            <p class="card-label">Total Owed</p>
            <p class="card-value text-red-400">
                ${{ (total_owed / 100) | round(2) }}
            </p>
        </div>

        <div class="card-muted">
            <p class="card-label">Customers Owing</p>
            <p class="card-value text-amber-400">{{ owing | length }}</p>
        </div>
    </section>

    <!-- Customer Table -->
    <section
        class="bg-gray-900 border border-gray-800 rounded-2xl overflow-hidden"
    >
        <header
            class="p-6 border-b border-gray-800 flex items-center justify-between gap-4 flex-wrap"
        >
            <h2 class="text-xl font-semibold">
                Customer List ({{ customers | length }})
            </h2>

            <input
                id="customer-search"
                type="search"
                placeholder="Search customers…"
                class="input w-full sm:w-64"
            />
        </header>

        {% if customers %}
        <div class="overflow-x-auto">
            <table class="w-full text-sm" id="customer-table">
                <thead class="bg-gray-950 text-gray-400 uppercase text-xs">
                    <tr>
                        <th class="sortable px-6 py-4" data-key="name">Name</th>
                        <th class="sortable px-6 py-4" data-key="phone">
                            Phone
                        </th>
                        <th class="px-6 py-4">Address</th>
                        <th
                            class="sortable px-6 py-4 text-right"
                            data-key="balance"
                        >
                            Balance
                        </th>
                        <th class="sortable px-6 py-4" data-key="lastVisit">
                            Last Visit
                        </th>
                        <th class="px-6 py-4 text-right">Actions</th>
                    </tr>
                </thead>

                <tbody id="customer-body" class="divide-y divide-gray-800">
                    {% for c in customers %}
                    <tr
                        class="customer-row"
                        data-name="{{ c.name | lower }}"
                        data-phone="{{ c.phone or '' }}"
                        data-balance="{{ c.balance_cents }}"
                        data-lastvisit="{{ c.last_visit_at.isoformat() if c.last_visit_at else '1900-01-01' }}"
                    >
                        <td class="px-6 py-4 font-medium">
                            <a
                                href="{{ url_for('customers.customer_detail', customer_id=c.id) }}"
                                class="hover:text-blue-400"
                            >
                                {{ c.name }}
                            </a>
                        </td>

                        <td class="px-6 py-4 text-gray-400">
                            {{ c.phone or '—' }}
                        </td>

                        <td class="px-6 py-4 text-gray-400">
                            {{ c.address or '—' }}
                        </td>

                        <td class="px-6 py-4 text-right">
                            <span
                                class="{% if c.balance_cents > 0 %}text-red-400 font-medium{% else %}text-gray-400{% endif %}"
                            >
                                ${{ (c.balance_cents / 100) | round(2) }}
                            </span>
                        </td>

                        <td class="px-6 py-4 text-gray-400">
                            {% if c.last_visit_at %} {{
                            c.last_visit_at.strftime('%b %d, %Y') }} {% else %}
                            Never {% endif %}
                        </td>

                        <td class="px-6 py-4 text-right space-x-2">
                            <button
                                class="btn-secondary btn-edit"
                                data-id="{{ c.id }}"
                                data-name="{{ c.name }}"
                                data-phone="{{ c.phone or '' }}"
                                data-address="{{ c.address or '' }}"
                                data-balance="{{ (c.balance_cents / 100) | round(2) }}"
                            >
                                Edit
                            </button>

                            <form
                                method="post"
                                action="{{ url_for('customers.customer_delete', customer_id=c.id) }}"
                                class="inline"
                                onsubmit="return confirm('Delete {{ c.name }}?');"
                            >
                                <button type="submit" class="btn-danger">
                                    Delete
                                </button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="p-12 text-center text-gray-500">No customers yet.</div>
        {% endif %}
    </section>

    <!-- Add Customer -->
    <section
        id="add-form"
        class="bg-gray-900 border border-gray-800 rounded-2xl p-8"
    >
        <h2 class="text-xl font-semibold mb-6">Add New Customer</h2>

        <form
            method="post"
            action="{{ url_for('customers.customer_add') }}"
            class="grid grid-cols-1 md:grid-cols-2 gap-6"
        >
            <div>
                <label class="label">Name *</label>
                <input name="name" required class="input" />
            </div>

            <div>
                <label class="label">Phone</label>
                <input name="phone" class="input" />
            </div>

            <div class="md:col-span-2">
                <label class="label">Address</label>
                <input name="address" class="input" />
            </div>

            <div>
                <label class="label">Starting Balance ($)</label>
                <input
                    name="balance"
                    type="number"
                    step="0.01"
                    value="0.00"
                    class="input"
                />
            </div>

            <div class="md:col-span-2 text-right">
                <button class="btn-primary px-8 py-3">Add Customer</button>
            </div>
        </form>
    </section>
</div>

<!-- Edit Modal -->
<div id="edit-modal" class="modal hidden">
    <div class="modal-card max-w-md">
        <h3 class="text-xl font-semibold mb-6">Edit Customer</h3>

        <form id="edit-form" method="post" class="space-y-4">
            <input type="hidden" name="customer_id" />

            <div>
                <label class="label">Name</label>
                <input name="name" class="input" required />
            </div>

            <div>
                <label class="label">Phone</label>
                <input name="phone" class="input" />
            </div>

            <div>
                <label class="label">Address</label>
                <input name="address" class="input" />
            </div>

            <div>
                <label class="label">Balance ($)</label>
                <input
                    name="balance"
                    type="number"
                    step="0.01"
                    class="input font-semibold"
                />
            </div>

            <div class="flex gap-3 pt-4">
                <button
                    type="button"
                    data-action="close"
                    class="btn-secondary flex-1"
                >
                    Cancel
                </button>
                <button class="btn-primary flex-1">Save</button>
            </div>
        </form>
    </div>
</div>

{% endblock %} {% block scripts %}
<script>
    (() => {
        const rows = [...document.querySelectorAll(".customer-row")];
        const search = document.getElementById("customer-search");
        const table = document.getElementById("customer-body");
        const modal = document.getElementById("edit-modal");
        const form = document.getElementById("edit-form");

        let sort = { key: null, dir: 1 };

        // Scroll to add
        document
            .querySelector('[data-action="scroll-add"]')
            ?.addEventListener("click", () =>
                document
                    .getElementById("add-form")
                    .scrollIntoView({ behavior: "smooth" }),
            );

        // Search
        search?.addEventListener("input", () => {
            const q = search.value.toLowerCase();
            rows.forEach((r) => {
                r.style.display = r.textContent.toLowerCase().includes(q)
                    ? ""
                    : "none";
            });
        });

        // Sorting
        document.querySelectorAll("[data-key]").forEach((th) => {
            th.addEventListener("click", () => {
                const key = th.dataset.key;
                sort.dir = sort.key === key ? -sort.dir : 1;
                sort.key = key;

                rows.sort((a, b) => {
                    let A = a.dataset[key];
                    let B = b.dataset[key];

                    if (!isNaN(A)) return sort.dir * (A - B);
                    return sort.dir * A.localeCompare(B);
                });

                rows.forEach((r) => table.appendChild(r));
            });
        });

        // Edit modal
        document.querySelectorAll(".btn-edit").forEach((btn) => {
            btn.addEventListener("click", () => {
                form.action =
                    "{{ url_for('customers.customer_edit', customer_id=0) }}".replace(
                        "0",
                        btn.dataset.id,
                    );

                form.customer_id.value = btn.dataset.id;
                form.name.value = btn.dataset.name;
                form.phone.value = btn.dataset.phone;
                form.address.value = btn.dataset.address;
                form.balance.value = btn.dataset.balance;

                modal.classList.remove("hidden");
            });
        });

        document
            .querySelectorAll('[data-action="close"]')
            .forEach((btn) =>
                btn.addEventListener("click", () =>
                    modal.classList.add("hidden"),
                ),
            );

        document.addEventListener("keydown", (e) => {
            if (e.key === "Escape") modal.classList.add("hidden");
        });
    })();
</script>
{% endblock %}
