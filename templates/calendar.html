{% extends "base.html" %} {% block title %}Calendar{% endblock %} {% block
content %}
<div class="max-w-6xl mx-auto space-y-6">
    <!-- Header -->
    <header>
        <h1 class="text-2xl sm:text-3xl font-bold">Calendar</h1>
        <p class="text-sm text-gray-400 mt-1">
            Plan routes and review scheduled visits.
        </p>
    </header>

    <!-- View Controls -->
    <div class="flex items-center justify-between gap-3">
        <div class="flex gap-2">
            <button
                class="view-btn bg-blue-600 text-white px-4 py-2 rounded-lg text-sm"
                data-view="week"
            >
                Week
            </button>
            <button
                class="view-btn bg-gray-800 hover:bg-gray-700 px-4 py-2 rounded-lg text-sm"
                data-view="month"
            >
                Month
            </button>
        </div>

        <div class="text-sm text-gray-400">{{ today }}</div>
    </div>

    <!-- Analytics -->
    <section class="grid grid-cols-2 sm:grid-cols-4 gap-4">
        <div class="bg-gray-900 border border-gray-800 rounded-xl p-4">
            <div class="text-xs text-gray-500">Total Stops</div>
            <div class="text-2xl font-bold" id="stat-total">—</div>
        </div>
        <div class="bg-gray-900 border border-gray-800 rounded-xl p-4">
            <div class="text-xs text-gray-500">Completed</div>
            <div class="text-2xl font-bold text-green-400" id="stat-completed">
                —
            </div>
        </div>
        <div class="bg-gray-900 border border-gray-800 rounded-xl p-4">
            <div class="text-xs text-gray-500">Completion %</div>
            <div class="text-2xl font-bold" id="stat-rate">—%</div>
        </div>
        <div class="bg-gray-900 border border-gray-800 rounded-xl p-4">
            <div class="text-xs text-gray-500">Avg / Day</div>
            <div class="text-2xl font-bold" id="stat-avg">—</div>
        </div>
    </section>

    <!-- WEEK VIEW -->
    <section id="week-view" class="space-y-2">
        <div class="grid grid-cols-7 text-xs text-gray-400 uppercase">
            <div>Mon</div>
            <div>Tue</div>
            <div>Wed</div>
            <div>Thu</div>
            <div>Fri</div>
            <div>Sat</div>
            <div>Sun</div>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-7 gap-2">
            {% for date in week_dates %} {% set visits =
            scheduled_visits.get(date, []) %}
            <div
                class="bg-gray-900 border border-gray-800 rounded-xl p-3 min-h-[140px]"
            >
                <div class="flex justify-between items-center mb-2">
                    <span class="font-semibold text-sm">
                        {{ date[-2:] }} {% if date == today %}
                        <span class="ml-1 text-xs bg-blue-600 px-1.5 rounded">
                            Today
                        </span>
                        {% endif %}
                    </span>
                    <span class="text-xs text-gray-500">
                        {{ visits|length }}
                    </span>
                </div>

                <ul class="space-y-1 text-xs">
                    {% if visits %} {% for v in visits %}
                    <li class="flex justify-between gap-2 truncate">
                        <span class="truncate">{{ v.customer_name }}</span>
                        {% if v.completed %}
                        <span class="text-green-400">✓</span>
                        {% endif %}
                    </li>
                    {% endfor %} {% else %}
                    <li class="text-gray-500">No visits</li>
                    {% endif %}
                </ul>
            </div>
            {% endfor %}
        </div>
    </section>

    <!-- MONTH VIEW -->
    <section id="month-view" class="hidden space-y-2">
        <div class="grid grid-cols-7 text-xs text-gray-400 uppercase">
            <div>Mon</div>
            <div>Tue</div>
            <div>Wed</div>
            <div>Thu</div>
            <div>Fri</div>
            <div>Sat</div>
            <div>Sun</div>
        </div>

        <div class="grid grid-cols-7 gap-2">
            {% for date in month_dates %} {% set visits =
            scheduled_visits.get(date, []) %}
            <div
                class="border border-gray-800 rounded-xl p-2 min-h-[110px] {% if visits|length == 0 %}bg-gray-900{% elif visits|length < 3 %}bg-blue-900/30{% elif visits|length < 6 %}bg-orange-900/40{% else %}bg-red-900/50{% endif %}"
            >
                <div class="text-xs font-semibold mb-1">
                    {{ date[-2:] }} {% if date == today %}
                    <span class="ml-1 text-[10px] bg-blue-600 px-1 rounded">
                        Today
                    </span>
                    {% endif %}
                </div>

                {% if visits %} {% for v in visits[:3] %}
                <div class="truncate text-xs">
                    {{ v.customer_name }} {% if v.completed %}
                    <span class="text-green-400">✓</span>
                    {% endif %}
                </div>
                {% endfor %} {% if visits|length > 3 %}
                <div class="text-xs text-gray-400">
                    +{{ visits|length - 3 }} more
                </div>
                {% endif %} {% endif %}
            </div>
            {% endfor %}
        </div>
    </section>
</div>

<script>
    (() => {
        const weekView = document.getElementById("week-view");
        const monthView = document.getElementById("month-view");
        const buttons = document.querySelectorAll(".view-btn");

        function computeStats() {
            let total = 0;
            let completed = 0;
            let days = new Set();

            document.querySelectorAll("[data-date], .bg-gray-900").forEach(() => {});

            {% for date, visits in scheduled_visits.items() %}
                total += {{ visits|length }};
                completed += {{ visits | selectattr("completed") | list | length }};
                if ({{ visits|length }} > 0) days.add("{{ date }}");
            {% endfor %}

            const avg = days.size ? (total / days.size).toFixed(1) : 0;
            const rate = total ? Math.round((completed / total) * 100) : 0;

            document.getElementById("stat-total").textContent = total;
            document.getElementById("stat-completed").textContent = completed;
            document.getElementById("stat-rate").textContent = rate + "%";
            document.getElementById("stat-avg").textContent = avg;
        }

        buttons.forEach(btn => {
            btn.addEventListener("click", () => {
                buttons.forEach(b => b.classList.remove("bg-blue-600","text-white"));
                btn.classList.add("bg-blue-600","text-white");

                const isWeek = btn.dataset.view === "week";
                weekView.classList.toggle("hidden", !isWeek);
                monthView.classList.toggle("hidden", isWeek);
            });
        });

        computeStats();
    })();
</script>

{% endblock %}
