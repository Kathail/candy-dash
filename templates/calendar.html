{% extends "base.html" %} {% block title %}Calendar & Planning{% endblock %} {%
block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 lg:py-10 space-y-8">
    <!-- Header -->
    <div
        class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 flex-wrap"
    >
        <div>
            <h1 class="text-2xl sm:text-3xl font-bold text-white">
                Calendar & Planning
            </h1>
            <p class="mt-1 text-sm text-gray-400">
                Plan routes and track customer visit schedules
            </p>
        </div>
        <div class="flex items-center gap-3">
            <div class="flex rounded-lg shadow-sm overflow-hidden" role="group">
                <button
                    type="button"
                    class="view-btn px-5 py-2.5 text-sm font-medium bg-blue-600 text-white hover:bg-blue-700 focus:z-10 focus:ring-2 focus:ring-blue-500"
                    data-view="week"
                >
                    Week
                </button>
                <button
                    type="button"
                    class="view-btn px-5 py-2.5 text-sm font-medium bg-gray-800 text-gray-300 hover:bg-gray-700 focus:z-10 focus:ring-2 focus:ring-blue-500"
                    data-view="month"
                >
                    Month
                </button>
            </div>
        </div>
    </div>

    <!-- Quick Stats Row -->
    <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 lg:gap-6">
        <div
            class="bg-gray-800 border border-gray-700 rounded-xl p-5 shadow-sm"
        >
            <p
                class="text-xs font-medium text-gray-400 uppercase tracking-wide"
            >
                Total Stops
            </p>
            <p id="stat-total" class="mt-2 text-3xl font-bold text-white">—</p>
        </div>
        <div
            class="bg-gray-800 border border-gray-700 rounded-xl p-5 shadow-sm"
        >
            <p
                class="text-xs font-medium text-gray-400 uppercase tracking-wide"
            >
                Completed
            </p>
            <p
                id="stat-completed"
                class="mt-2 text-3xl font-bold text-green-400"
            >
                —
            </p>
        </div>
        <div
            class="bg-gray-800 border border-gray-700 rounded-xl p-5 shadow-sm"
        >
            <p
                class="text-xs font-medium text-gray-400 uppercase tracking-wide"
            >
                Completion %
            </p>
            <p id="stat-rate" class="mt-2 text-3xl font-bold text-white">—%</p>
        </div>
        <div
            class="bg-gray-800 border border-gray-700 rounded-xl p-5 shadow-sm"
        >
            <p
                class="text-xs font-medium text-gray-400 uppercase tracking-wide"
            >
                Avg / Day
            </p>
            <p id="stat-avg" class="mt-2 text-3xl font-bold text-white">—</p>
        </div>
    </div>

    <!-- Priority + Analytics + Tools Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Priority Visits -->
        <div
            class="bg-gray-800 border border-gray-700 rounded-xl p-5 shadow-sm"
        >
            <h2
                class="text-lg font-semibold mb-4 flex items-center gap-2 text-white"
            >
                <svg
                    class="w-5 h-5 text-yellow-500"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                    stroke-width="2"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
                    />
                </svg>
                Priority Visits
            </h2>
            <div class="space-y-3">
                {% if priority_visits %} {% for c in priority_visits[:5] %}
                <div
                    class="p-3 rounded-lg border border-gray-700 hover:bg-gray-700/50 transition cursor-pointer"
                >
                    <div class="flex justify-between items-start">
                        <div class="flex-1 min-w-0">
                            <div class="font-medium text-white truncate">
                                {{ c.name }}
                            </div>
                            <div class="text-xs text-gray-400 mt-1">
                                {% if c.days_since_visit < 999 %} Last visit: {{
                                c.days_since_visit | round | int }} days ago {%
                                else %} Never visited {% endif %}
                            </div>
                        </div>
                        <div class="ml-2">
                            {% if c.days_since_visit >= 60 or c.days_since_visit
                            == 999 %}
                            <span
                                class="px-2.5 py-1 text-xs rounded-full bg-red-900/50 text-red-300 font-medium"
                                >Urgent</span
                            >
                            {% elif c.days_since_visit >= 30 %}
                            <span
                                class="px-2.5 py-1 text-xs rounded-full bg-yellow-900/50 text-yellow-300 font-medium"
                                >Soon</span
                            >
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %} {% if priority_visits|length > 5 %}
                <a
                    href="{{ url_for('customers.customers') }}"
                    class="block text-center text-sm text-blue-400 hover:text-blue-300 pt-2"
                >
                    View all {{ priority_visits|length }} →
                </a>
                {% endif %} {% else %}
                <div class="text-center py-8 text-gray-500">
                    <p>All customers are up to date!</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Visit Analytics -->
        <div
            class="bg-gray-800 border border-gray-700 rounded-xl p-5 shadow-sm"
        >
            <h2
                class="text-lg font-semibold mb-4 flex items-center gap-2 text-white"
            >
                <svg
                    class="w-5 h-5 text-blue-500"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                    stroke-width="2"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"
                    />
                </svg>
                Visit Analytics
            </h2>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                <div
                    class="p-4 rounded-lg bg-blue-950/30 border border-blue-800/40"
                >
                    <div class="text-xs text-blue-400 mb-1">This Week</div>
                    <div class="text-2xl font-bold text-white">
                        {{ visits_this_week or 0 }}
                    </div>
                </div>
                <div
                    class="p-4 rounded-lg bg-green-950/30 border border-green-800/40"
                >
                    <div class="text-xs text-green-400 mb-1">This Month</div>
                    <div class="text-2xl font-bold text-white">
                        {{ visits_this_month or 0 }}
                    </div>
                </div>
                <div
                    class="p-4 rounded-lg bg-purple-950/30 border border-purple-800/40"
                >
                    <div class="text-xs text-purple-400 mb-1">Avg / Week</div>
                    <div class="text-2xl font-bold text-white">
                        {{ avg_per_week or 0 }}
                    </div>
                </div>
            </div>
        </div>

        <!-- Planning Tools -->
        <div
            class="bg-gray-800 border border-gray-700 rounded-xl p-5 shadow-sm"
        >
            <h2
                class="text-lg font-semibold mb-4 flex items-center gap-2 text-white"
            >
                <svg
                    class="w-5 h-5 text-green-500"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                    stroke-width="2"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"
                    />
                </svg>
                Planning Tools
            </h2>
            <div class="space-y-3">
                <button
                    onclick="openPlanAheadModal()"
                    class="w-full text-left p-4 rounded-lg border border-blue-800/40 bg-blue-950/20 hover:bg-blue-950/40 transition-all"
                >
                    <div class="font-semibold text-blue-300 mb-1">
                        Plan Ahead
                    </div>
                    <div class="text-xs text-blue-400">
                        Schedule customers approaching 30 days
                    </div>
                </button>
                <a
                    href="{{ url_for('customers.customers') }}?filter=never"
                    class="block w-full text-left p-4 rounded-lg border border-purple-800/40 bg-purple-950/20 hover:bg-purple-950/40 transition-all"
                >
                    <div
                        class="font-semibold text-purple-300 mb-1 flex items-center justify-between"
                    >
                        New Customers {% if never_visited > 0 %}
                        <span
                            class="px-2 py-0.5 text-xs rounded-full bg-purple-800 text-purple-100"
                            >{{ never_visited }}</span
                        >
                        {% endif %}
                    </div>
                    <div class="text-xs text-purple-400">
                        {% if never_visited > 0 %} {{ never_visited }} customers
                        need first visit {% else %} All customers visited at
                        least once! {% endif %}
                    </div>
                </a>
                <button
                    onclick="openRouteOptimizerModal()"
                    class="w-full text-left p-4 rounded-lg border border-green-800/40 bg-green-950/20 hover:bg-green-950/40 transition-all"
                >
                    <div class="font-semibold text-green-300 mb-1">
                        Optimize Routes
                    </div>
                    <div class="text-xs text-green-400">
                        Group by location to save time
                    </div>
                </button>
            </div>
        </div>
    </div>

    <!-- Calendar Section -->
    <div
        class="bg-gray-800 border border-gray-700 rounded-xl p-5 lg:p-6 shadow-sm"
    >
        <div class="flex items-center justify-between mb-6 flex-wrap gap-4">
            <button
                id="prev-month"
                class="p-3 rounded-lg hover:bg-gray-700 transition"
            >
                <svg
                    class="w-6 h-6"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                    stroke-width="2"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        d="M15 19l-7-7 7-7"
                    />
                </svg>
            </button>
            <div class="text-center">
                <h2
                    id="current-month"
                    class="text-xl sm:text-2xl font-bold text-white"
                ></h2>
                <div class="text-sm text-gray-400 mt-1">
                    Click a day to plan route
                </div>
            </div>
            <button
                id="next-month"
                class="p-3 rounded-lg hover:bg-gray-700 transition"
            >
                <svg
                    class="w-6 h-6"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                    stroke-width="2"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        d="M9 5l7 7-7 7"
                    />
                </svg>
            </button>
        </div>

        <div
            class="grid grid-cols-7 gap-2 mb-3 text-xs font-medium text-gray-400 uppercase tracking-wider text-center hidden sm:grid"
        >
            <div>Sun</div>
            <div>Mon</div>
            <div>Tue</div>
            <div>Wed</div>
            <div>Thu</div>
            <div>Fri</div>
            <div>Sat</div>
        </div>

        <div id="calendar-grid" class="grid grid-cols-7 gap-2"></div>
    </div>
</div>

<!-- Plan Ahead Modal -->
<div
    id="plan-ahead-modal"
    class="hidden fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4"
>
    <div
        class="bg-gray-900 border border-gray-700 rounded-2xl p-6 max-w-2xl w-full max-h-[85vh] overflow-y-auto"
    >
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-bold text-white">
                Customers Approaching 30 Days
            </h3>
            <button
                onclick="
                    document
                        .getElementById('plan-ahead-modal')
                        .classList.add('hidden')
                "
                class="p-2 hover:bg-gray-700 rounded-lg"
            >
                <svg
                    class="w-6 h-6"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                    stroke-width="2"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        d="M6 18L18 6M6 6l12 12"
                    />
                </svg>
            </button>
        </div>
        <div id="plan-ahead-content" class="space-y-3">
            <!-- Populated by JS -->
        </div>
    </div>
</div>

<!-- Route Optimizer Modal -->
<div
    id="route-optimizer-modal"
    class="hidden fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4"
>
    <div
        class="bg-gray-900 border border-gray-700 rounded-2xl p-6 max-w-3xl w-full max-h-[85vh] overflow-y-auto"
    >
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-bold text-white">Route Optimizer</h3>
            <button
                onclick="
                    document
                        .getElementById('route-optimizer-modal')
                        .classList.add('hidden')
                "
                class="p-2 hover:bg-gray-700 rounded-lg"
            >
                <svg
                    class="w-6 h-6"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                    stroke-width="2"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        d="M6 18L18 6M6 6l12 12"
                    />
                </svg>
            </button>
        </div>
        <div id="route-optimizer-content" class="space-y-4">
            <!-- Populated by JS -->
        </div>
    </div>
</div>

<!-- Plan Day Modal -->
<div
    id="plan-day-modal"
    class="hidden fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4"
>
    <div
        class="bg-gray-900 border border-gray-700 rounded-2xl p-6 max-w-xl w-full max-h-[85vh] overflow-y-auto"
    >
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-bold text-white">
                Plan Route for <span id="plan-day-date"></span>
            </h3>
            <button
                onclick="
                    document
                        .getElementById('plan-day-modal')
                        .classList.add('hidden')
                "
                class="p-2 hover:bg-gray-700 rounded-lg"
            >
                <svg
                    class="w-6 h-6"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                    stroke-width="2"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        d="M6 18L18 6M6 6l12 12"
                    />
                </svg>
            </button>
        </div>
        <div id="plan-day-content" class="space-y-4">
            <!-- Populated by JS -->
        </div>
    </div>
</div>

<script>
    // ============================================================================
    // Calendar Page – Fully functional (no backend changes)
    // ============================================================================

    // Data from backend
    const scheduledData = {
        {% for date_str, visits in scheduled_visits.items() %}
            "{{ date_str }}": {{ visits | tojson }},
        {% endfor %}
    };

    let currentMonth = new Date();

    function renderCalendar() {
        const year = currentMonth.getFullYear();
        const month = currentMonth.getMonth();
        const monthNames = ["January","February","March","April","May","June","July","August","September","October","November","December"];
        document.getElementById("current-month").textContent = `${monthNames[month]} ${year}`;

        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const today = new Date();
        const grid = document.getElementById("calendar-grid");
        grid.innerHTML = "";

        for (let i = 0; i < firstDay; i++) {
            grid.appendChild(document.createElement("div"));
        }

        for (let day = 1; day <= daysInMonth; day++) {
            const dateObj = new Date(year, month, day);
            const dateStr = dateObj.toISOString().split("T")[0];
            const isToday = dateObj.toDateString() === today.toDateString();
            const isPast = dateObj < today && !isToday;

            const cell = document.createElement("div");
            cell.className = `
                aspect-square p-2 rounded-lg border transition-all cursor-pointer text-center
                ${isToday ? 'bg-blue-900/40 border-blue-600 font-bold' : 'border-gray-700 hover:bg-gray-700/50'}
                ${isPast ? 'opacity-50 cursor-not-allowed' : ''}
            `;
            cell.innerHTML = `<div class="text-lg ${isToday ? 'text-blue-300' : 'text-gray-200'}">${day}</div>`;

            const visits = scheduledData[dateStr] || [];
            if (visits.length > 0) {
                const count = document.createElement("div");
                count.className = "text-xs mt-1 " + (isToday ? "text-blue-400" : "text-gray-400");
                count.textContent = visits.length + " stops";
                cell.appendChild(count);
            }

            if (!isPast) {
                cell.addEventListener("click", () => openPlanDayModal(dateStr));
            }

            grid.appendChild(cell);
        }
    }

    document.getElementById("prev-month")?.addEventListener("click", () => {
        currentMonth.setMonth(currentMonth.getMonth() - 1);
        renderCalendar();
    });

    document.getElementById("next-month")?.addEventListener("click", () => {
        currentMonth.setMonth(currentMonth.getMonth() + 1);
        renderCalendar();
    });

    // Stats
    function computeStats() {
        let total = 0, completed = 0, daysWith = 0;
        Object.values(scheduledData).forEach(visits => {
            const cnt = visits.length;
            total += cnt;
            completed += visits.filter(v => v.completed).length;
            if (cnt > 0) daysWith++;
        });
        const avg = daysWith ? (total / daysWith).toFixed(1) : "0.0";
        const rate = total ? Math.round((completed / total) * 100) : 0;

        document.getElementById("stat-total").textContent = total;
        document.getElementById("stat-completed").textContent = completed;
        document.getElementById("stat-rate").textContent = rate + "%";
        document.getElementById("stat-avg").textContent = avg;
    }

    // Plan Ahead Modal – using /calendar/overdue
    async function openPlanAheadModal() {
        const modal = document.getElementById("plan-ahead-modal");
        modal.classList.remove("hidden");

        const content = document.getElementById("plan-ahead-content");
        content.innerHTML = '<div class="text-center py-8 text-gray-400">Loading...</div>';

        try {
            const res = await fetch("/calendar/overdue");
            if (!res.ok) throw new Error();
            const customers = await res.json();

            // Show only those approaching 30 days (adjust range as needed)
            const approaching = customers.filter(c => c.days_since && c.days_since >= 20 && c.days_since <= 35);

            if (!approaching.length) {
                content.innerHTML = '<div class="text-center py-8 text-gray-400">No customers approaching 30 days.</div>';
                return;
            }

            content.innerHTML = approaching.map(c => `
                <div class="p-3 rounded-lg border border-gray-700 hover:bg-gray-700/50 transition flex justify-between items-center">
                    <div>
                        <div class="font-medium text-white">${c.name}</div>
                        <div class="text-xs text-gray-400">${c.days_since} days since last visit</div>
                    </div>
                    <form method="post" action="/route/add/${c.id}">
                        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition">
                            Add to Route
                        </button>
                    </form>
                </div>
            `).join('');
        } catch {
            content.innerHTML = '<div class="text-center py-8 text-red-400">Failed to load.</div>';
        }
    }

    // Route Optimizer Modal – using /calendar/customers_by_area
    async function openRouteOptimizerModal() {
        const modal = document.getElementById("route-optimizer-modal");
        modal.classList.remove("hidden");

        const content = document.getElementById("route-optimizer-content");
        content.innerHTML = '<div class="text-center py-8 text-gray-400">Loading...</div>';

        try {
            const res = await fetch("/calendar/customers_by_area");
            if (!res.ok) throw new Error();
            const groups = await res.json();

            if (!Object.keys(groups).length) {
                content.innerHTML = '<div class="text-center py-8 text-gray-400">No priority customers by area.</div>';
                return;
            }

            content.innerHTML = Object.entries(groups).map(([area, customers]) => `
                <div class="mb-6">
                    <h4 class="text-lg font-semibold text-white mb-3">${area} (${customers.length})</h4>
                    <div class="space-y-2">
                        ${customers.map(c => `
                            <div class="p-3 rounded-lg border border-gray-700 flex justify-between items-center hover:bg-gray-700/50 transition">
                                <div>
                                    <div class="font-medium text-white">${c.name}</div>
                                    <div class="text-xs text-gray-400">${c.address || "No address"}</div>
                                </div>
                                <form method="post" action="/route/add/${c.id}">
                                    <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition">
                                        Add
                                    </button>
                                </form>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        } catch {
            content.innerHTML = '<div class="text-center py-8 text-red-400">Failed to load.</div>';
        }
    }

    // Plan Day Modal – using /api/customers/json
    async function openPlanDayModal(dateStr) {
        const modal = document.getElementById("plan-day-modal");
        modal.classList.remove("hidden");

        document.getElementById("plan-day-date").textContent = dateStr;

        const content = document.getElementById("plan-day-content");
        content.innerHTML = '<div class="text-center py-8 text-gray-400">Loading customers...</div>';

        try {
            const res = await fetch("/api/customers/json");
            if (!res.ok) throw new Error();
            const customers = await res.json();

            content.innerHTML = `
                <form method="post" action="/route/add" class="space-y-4">
                    <input type="hidden" name="date" value="${dateStr}">
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Add Customer to ${dateStr}</label>
                        <select name="customer_id" required class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2.5 text-white focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none transition">
                            <option value="">Select customer...</option>
                            ${customers.map(c => `
                                <option value="${c.id}">${c.name}${c.balance_cents > 0 ? ' (owes $' + (c.balance_cents/100).toFixed(2) + ')' : ''}</option>
                            `).join('')}
                        </select>
                    </div>
                    <div class="flex justify-end">
                        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2.5 rounded-lg font-medium transition">
                            Add to Route
                        </button>
                    </div>
                </form>
            `;
        } catch {
            content.innerHTML = '<div class="text-center py-8 text-red-400">Failed to load customers.</div>';
        }
    }

    // Stats
    function computeStats() {
        let total = 0, completed = 0, daysWith = 0;
        Object.values(scheduledData).forEach(visits => {
            const cnt = visits.length;
            total += cnt;
            completed += visits.filter(v => v.completed).length;
            if (cnt > 0) daysWith++;
        });
        const avg = daysWith ? (total / daysWith).toFixed(1) : "0.0";
        const rate = total ? Math.round((completed / total) * 100) : 0;

        document.getElementById("stat-total").textContent = total;
        document.getElementById("stat-completed").textContent = completed;
        document.getElementById("stat-rate").textContent = rate + "%";
        document.getElementById("stat-avg").textContent = avg;
    }

    // Close modals on Esc
    document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
            document.querySelectorAll('.hidden.fixed:not(.hidden)').forEach(m => m.classList.add('hidden'));
        }
    });

    // Init
    renderCalendar();
    computeStats();
</script>
{% endblock %}
