{% extends "base.html" %} {% block page_title %}Calendar & Planning{% endblock
%} {% block content %}
<div class="max-w-7xl mx-auto">
    <div class="mb-6">
        <h1
            class="text-2xl md:text-3xl font-bold text-gray-900 dark:text-white"
        >
            Calendar & Planning
        </h1>
        <p class="text-gray-600 dark:text-gray-300 mt-1">
            Plan your routes and track customer visit schedules
        </p>
    </div>

    <!-- PLANNING GRID -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-6">
        <!-- CUSTOMERS NEEDING VISITS -->
        <div
            class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-5"
        >
            <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
                <svg
                    class="w-5 h-5 text-yellow-600"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
                    ></path>
                </svg>
                Priority Visits
            </h2>

            <div class="space-y-2">
                {% if priority_customers %} {% for customer in
                priority_customers[:5] %}
                <div
                    class="p-3 rounded-lg border border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700/50 cursor-pointer transition-all"
                >
                    <div class="flex justify-between items-start">
                        <div class="flex-1 min-w-0">
                            <div class="font-medium text-sm truncate">
                                {{ customer.name }}
                            </div>
                            <div
                                class="text-xs text-gray-500 dark:text-gray-400 mt-1"
                            >
                                {% if customer.last_visit %} Last visit: {{
                                customer.days_since }} days ago {% else %} Never
                                visited {% endif %}
                            </div>
                        </div>
                        <div class="ml-2">
                            {% if not customer.last_visit or
                            (customer.days_since and customer.days_since >= 60)
                            %}
                            <span
                                class="px-2 py-1 text-xs rounded-full bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-300 font-medium"
                                >Urgent</span
                            >
                            {% elif customer.days_since and customer.days_since
                            >= 30 %}
                            <span
                                class="px-2 py-1 text-xs rounded-full bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-300 font-medium"
                                >Soon</span
                            >
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %} {% if priority_customers|length > 5 %}
                <a
                    href="{{ url_for('customers') }}"
                    class="block text-center text-sm text-blue-600 dark:text-blue-400 hover:underline pt-2 font-medium"
                >
                    View all {{ priority_customers|length }} customers â†’
                </a>
                {% endif %} {% else %}
                <div class="text-center py-8 text-gray-500 dark:text-gray-400">
                    <svg
                        class="w-16 h-16 mx-auto mb-3 text-gray-300 dark:text-gray-600"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
                        ></path>
                    </svg>
                    <p class="font-medium">All customers are up to date!</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- VISIT FREQUENCY ANALYSIS -->
        <div
            class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-5"
        >
            <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
                <svg
                    class="w-5 h-5 text-blue-600"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"
                    ></path>
                </svg>
                Visit Analytics
            </h2>

            <div class="space-y-3">
                <div
                    class="p-4 rounded-lg bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800"
                >
                    <div
                        class="text-xs text-blue-800 dark:text-blue-300 mb-1 font-medium"
                    >
                        This Week
                    </div>
                    <div
                        class="text-3xl font-bold text-blue-900 dark:text-blue-100"
                    >
                        {{ visits_this_week or 0 }}
                    </div>
                    <div class="text-xs text-blue-700 dark:text-blue-400 mt-1">
                        visits completed
                    </div>
                </div>

                <div
                    class="p-4 rounded-lg bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800"
                >
                    <div
                        class="text-xs text-green-800 dark:text-green-300 mb-1 font-medium"
                    >
                        This Month
                    </div>
                    <div
                        class="text-3xl font-bold text-green-900 dark:text-green-100"
                    >
                        {{ visits_this_month or 0 }}
                    </div>
                    <div
                        class="text-xs text-green-700 dark:text-green-400 mt-1"
                    >
                        visits completed
                    </div>
                </div>

                <div
                    class="p-4 rounded-lg bg-purple-50 dark:bg-purple-900/20 border border-purple-200 dark:border-purple-800"
                >
                    <div
                        class="text-xs text-purple-800 dark:text-purple-300 mb-1 font-medium"
                    >
                        Average per Week
                    </div>
                    <div
                        class="text-3xl font-bold text-purple-900 dark:text-purple-100"
                    >
                        {{ avg_visits_per_week or 0 }}
                    </div>
                    <div
                        class="text-xs text-purple-700 dark:text-purple-400 mt-1"
                    >
                        visits
                    </div>
                </div>
            </div>
        </div>

        <!-- PLANNING TOOLS -->
        <div
            class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-5"
        >
            <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
                <svg
                    class="w-5 h-5 text-green-600"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"
                    ></path>
                </svg>
                Planning Tools
            </h2>

            <div class="space-y-3">
                <button
                    onclick="window.showUpcomingVisits()"
                    class="w-full text-left p-4 rounded-lg border-2 border-blue-200 dark:border-blue-800 bg-blue-50 dark:bg-blue-900/20 hover:bg-blue-100 dark:hover:bg-blue-900/30 transition-all"
                >
                    <div
                        class="font-semibold text-blue-900 dark:text-blue-100 mb-2 flex items-center gap-2"
                    >
                        <span class="text-xl">ðŸ’¡</span>
                        Plan Ahead
                    </div>
                    <div class="text-xs text-blue-800 dark:text-blue-300">
                        Schedule visits for customers approaching 30 days
                    </div>
                </button>

                <a
                    href="{{ url_for('customers') }}?filter=never"
                    class="block w-full text-left p-4 rounded-lg border-2 border-purple-200 dark:border-purple-800 bg-purple-50 dark:bg-purple-900/20 hover:bg-purple-100 dark:hover:bg-purple-900/30 transition-all"
                >
                    <div
                        class="font-semibold text-purple-900 dark:text-purple-100 mb-2 flex items-center gap-2"
                    >
                        <span class="text-xl">ðŸŽ¯</span>
                        New Customers {% if never_visited > 0 %}
                        <span
                            class="ml-auto px-2 py-1 text-xs rounded-full bg-purple-200 dark:bg-purple-800 text-purple-900 dark:text-purple-100 font-bold"
                        >
                            {{ never_visited }}
                        </span>
                        {% endif %}
                    </div>
                    <div class="text-xs text-purple-800 dark:text-purple-300">
                        {% if never_visited > 0 %} {{ never_visited }} customers
                        need first visit {% else %} All customers visited at
                        least once! {% endif %}
                    </div>
                </a>

                <button
                    onclick="window.showRouteOptimizer()"
                    class="w-full text-left p-4 rounded-lg border-2 border-green-200 dark:border-green-800 bg-green-50 dark:bg-green-900/20 hover:bg-green-100 dark:hover:bg-green-900/30 transition-all"
                >
                    <div
                        class="font-semibold text-green-900 dark:text-green-100 mb-2 flex items-center gap-2"
                    >
                        <span class="text-xl">ðŸ“Š</span>
                        Optimize Routes
                    </div>
                    <div class="text-xs text-green-800 dark:text-green-300">
                        Group customers by location to save time and fuel
                    </div>
                </button>
            </div>
        </div>
    </div>

    <!-- CALENDAR -->
    <div
        class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-5"
    >
        <div class="flex items-center justify-between mb-6">
            <button
                id="prev-month"
                class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
            >
                <svg
                    class="w-5 h-5"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M15 19l-7-7 7-7"
                    ></path>
                </svg>
            </button>

            <div class="text-center">
                <h2
                    id="current-month"
                    class="text-xl font-bold text-gray-900 dark:text-white"
                ></h2>
                <div class="text-sm text-gray-500 dark:text-gray-400 mt-1">
                    Click a day to plan route
                </div>
            </div>

            <button
                id="next-month"
                class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
            >
                <svg
                    class="w-5 h-5"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M9 5l7 7-7 7"
                    ></path>
                </svg>
            </button>
        </div>

        <!-- Calendar Grid -->
        <div>
            <div class="grid grid-cols-7 gap-2 mb-2">
                <div
                    class="text-center text-xs font-semibold text-gray-500 dark:text-gray-400 py-2"
                >
                    Sun
                </div>
                <div
                    class="text-center text-xs font-semibold text-gray-500 dark:text-gray-400 py-2"
                >
                    Mon
                </div>
                <div
                    class="text-center text-xs font-semibold text-gray-500 dark:text-gray-400 py-2"
                >
                    Tue
                </div>
                <div
                    class="text-center text-xs font-semibold text-gray-500 dark:text-gray-400 py-2"
                >
                    Wed
                </div>
                <div
                    class="text-center text-xs font-semibold text-gray-500 dark:text-gray-400 py-2"
                >
                    Thu
                </div>
                <div
                    class="text-center text-xs font-semibold text-gray-500 dark:text-gray-400 py-2"
                >
                    Fri
                </div>
                <div
                    class="text-center text-xs font-semibold text-gray-500 dark:text-gray-400 py-2"
                >
                    Sat
                </div>
            </div>
            <div id="calendar-grid" class="grid grid-cols-7 gap-2"></div>
        </div>
    </div>
</div>

<!-- Plan Ahead Modal -->
<div
    id="plan-ahead-modal"
    class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4"
    onclick="if (event.target === this) this.classList.add('hidden');"
>
    <div
        class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-6 max-w-2xl w-full max-h-[85vh] overflow-y-auto"
        onclick="event.stopPropagation()"
    >
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold">Customers Approaching 30 Days</h3>
            <button
                onclick="
                    document
                        .getElementById('plan-ahead-modal')
                        .classList.add('hidden')
                "
                class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors"
            >
                <svg
                    class="w-6 h-6"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M6 18L18 6M6 6l12 12"
                    ></path>
                </svg>
            </button>
        </div>

        <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
            These customers will reach 30 days since last visit soon. Schedule
            them for your upcoming routes.
        </p>

        <div class="space-y-2">
            {% for customer in approaching_30_customers %}
            <div
                class="p-3 rounded-lg border border-gray-200 dark:border-gray-700 flex justify-between items-center hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors"
            >
                <div>
                    <div class="font-medium">{{ customer.name }}</div>
                    <div class="text-xs text-gray-500 dark:text-gray-400">
                        {% if customer.city %}{{ customer.city }} â€¢ {% endif %}
                        Last visit: {{ customer.days_since }} days ago
                    </div>
                </div>
                <form
                    action="/route/add/{{ customer.id }}"
                    method="post"
                    class="inline"
                >
                    <button
                        type="submit"
                        class="px-4 py-2 text-sm bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium"
                    >
                        Add to Route
                    </button>
                </form>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Route Optimizer Modal -->
<div
    id="route-optimizer-modal"
    class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4"
    onclick="if (event.target === this) this.classList.add('hidden');"
>
    <div
        class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-6 max-w-3xl w-full max-h-[85vh] overflow-y-auto"
        onclick="event.stopPropagation()"
    >
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold">Route Optimizer</h3>
            <button
                onclick="
                    document
                        .getElementById('route-optimizer-modal')
                        .classList.add('hidden')
                "
                class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors"
            >
                <svg
                    class="w-6 h-6"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M6 18L18 6M6 6l12 12"
                    ></path>
                </svg>
            </button>
        </div>

        <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
            Customers grouped by location for efficient routing
        </p>

        <div class="space-y-4">
            {% for city, city_customers in customers_by_location.items() %}
            <div
                class="border border-gray-200 dark:border-gray-700 rounded-lg p-4"
            >
                <div
                    class="font-semibold mb-3 flex items-center justify-between"
                >
                    <span class="text-lg"
                        >{{ city or 'No City Specified' }}</span
                    >
                    <span class="text-sm text-gray-500 dark:text-gray-400"
                        >{{ city_customers|length }} customers</span
                    >
                </div>
                <div class="space-y-2">
                    {% for customer in city_customers %}
                    <div
                        class="p-3 rounded-lg bg-gray-50 dark:bg-gray-700/50 flex justify-between items-center"
                    >
                        <div class="flex-1">
                            <span class="font-medium">{{ customer.name }}</span>
                            {% if customer.address %}
                            <span
                                class="text-xs text-gray-500 dark:text-gray-400 ml-2"
                                >{{ customer.address }}</span
                            >
                            {% endif %}
                        </div>
                        <form
                            action="/route/add/{{ customer.id }}"
                            method="post"
                            class="inline"
                        >
                            <button
                                type="submit"
                                class="px-3 py-1.5 text-xs bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-medium"
                            >
                                Add
                            </button>
                        </form>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<script>
    // Make functions globally accessible
    window.showUpcomingVisits = function () {
        document.getElementById("plan-ahead-modal").classList.remove("hidden");
    };

    window.showRouteOptimizer = function () {
        document
            .getElementById("route-optimizer-modal")
            .classList.remove("hidden");
    };

    // Calendar functionality
    let currentMonth = new Date();

    function renderCalendar() {
        const year = currentMonth.getFullYear();
        const month = currentMonth.getMonth();
        const monthNames = [
            "January",
            "February",
            "March",
            "April",
            "May",
            "June",
            "July",
            "August",
            "September",
            "October",
            "November",
            "December",
        ];

        document.getElementById("current-month").textContent =
            `${monthNames[month]} ${year}`;

        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const today = new Date();

        const grid = document.getElementById("calendar-grid");
        grid.innerHTML = "";

        // Empty cells before month starts
        for (let i = 0; i < firstDay; i++) {
            const emptyCell = document.createElement("div");
            emptyCell.className = "aspect-square";
            grid.appendChild(emptyCell);
        }

        // Days of month
        for (let day = 1; day <= daysInMonth; day++) {
            const date = new Date(year, month, day);
            const isToday = date.toDateString() === today.toDateString();
            const isPast = date < today && !isToday;
            const isWeekend = date.getDay() === 0 || date.getDay() === 6;

            const dayCell = document.createElement("div");
            dayCell.className = `
        aspect-square p-2 rounded-lg border transition-all cursor-pointer
        ${isToday ? "bg-blue-100 dark:bg-blue-900/30 border-blue-500 dark:border-blue-500 font-semibold" : "border-gray-200 dark:border-gray-700"}
        ${isPast ? "opacity-50" : "hover:bg-gray-50 dark:hover:bg-gray-700/50"}
        ${isWeekend ? "bg-gray-50 dark:bg-gray-800/50" : ""}
      `;

            dayCell.innerHTML = `
        <div class="text-sm ${isToday ? "text-blue-600 dark:text-blue-400 font-bold" : "text-gray-900 dark:text-white"}">${day}</div>
        ${isToday ? '<div class="text-xs text-blue-600 dark:text-blue-400 mt-1">Today</div>' : ""}
      `;

            grid.appendChild(dayCell);
        }
    }

    document.getElementById("prev-month").addEventListener("click", () => {
        currentMonth.setMonth(currentMonth.getMonth() - 1);
        renderCalendar();
    });

    document.getElementById("next-month").addEventListener("click", () => {
        currentMonth.setMonth(currentMonth.getMonth() + 1);
        renderCalendar();
    });

    // Close modals on escape
    document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
            document.getElementById("plan-ahead-modal").classList.add("hidden");
            document
                .getElementById("route-optimizer-modal")
                .classList.add("hidden");
        }
    });

    // Initialize calendar
    renderCalendar();
</script>
{% endblock %}
