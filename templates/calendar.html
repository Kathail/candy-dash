{% extends "base.html" %} {% block title %}Calendar{% endblock %} {% block
content %}
<div class="max-w-6xl mx-auto space-y-8">
    <!-- Header -->
    <section>
        <h1 class="text-3xl font-bold">Calendar</h1>
        <p class="text-gray-400 mt-1">
            Plan routes, optimize daily runs, and review performance.
        </p>
    </section>

    <!-- View Toggle -->
    <div class="flex justify-between items-center">
        <div class="flex gap-2">
            <button
                class="view-btn bg-blue-600 text-white px-4 py-2 rounded-lg text-sm"
                data-view="week"
            >
                Week
            </button>
            <button
                class="view-btn bg-gray-800 hover:bg-gray-700 px-4 py-2 rounded-lg text-sm"
                data-view="month"
            >
                Month
            </button>
        </div>
    </div>

    <!-- WEEK VIEW -->
    <section id="week-view" class="space-y-2">
        <div class="grid grid-cols-7 gap-2 text-xs text-gray-400 uppercase">
            <div>Mon</div>
            <div>Tue</div>
            <div>Wed</div>
            <div>Thu</div>
            <div>Fri</div>
            <div>Sat</div>
            <div>Sun</div>
        </div>

        <div class="grid grid-cols-7 gap-2">
            {% for date in week_dates %} {% set visits =
            scheduled_visits.get(date, []) %}
            <div
                class="day-cell bg-gray-900 border border-gray-800 rounded-xl p-2 min-h-[150px] cursor-pointer"
                data-date="{{ date }}"
                onclick="openDay('{{ date }}')"
            >
                <div class="flex justify-between items-center mb-1">
                    <span class="font-semibold text-sm">
                        {{ date[-2:] }} {% if date == today %}
                        <span class="ml-1 text-xs bg-blue-600 px-1.5 rounded"
                            >Today</span
                        >
                        {% endif %}
                    </span>
                    <span class="text-xs text-gray-500"
                        >{{ visits|length }}</span
                    >
                </div>

                <ul class="space-y-1 text-xs">
                    {% for v in visits %}
                    <li>{{ v.customer_name }}</li>
                    {% endfor %}
                </ul>

                {% if visits %}
                <button
                    class="optimize-btn mt-2 w-full text-xs bg-gray-800 hover:bg-gray-700 rounded py-1"
                    onclick="event.stopPropagation(); optimizeDay('{{ date }}')"
                >
                    Optimize
                </button>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </section>

    <!-- MONTH VIEW -->
    <section id="month-view" class="hidden space-y-2">
        <div class="grid grid-cols-7 gap-2 text-xs text-gray-400 uppercase">
            <div>Mon</div>
            <div>Tue</div>
            <div>Wed</div>
            <div>Thu</div>
            <div>Fri</div>
            <div>Sat</div>
            <div>Sun</div>
        </div>

        <div class="grid grid-cols-7 gap-2">
            {% for date in month_dates %} {% set visits =
            scheduled_visits.get(date, []) %} {% set count = visits | length %}
            {% if count == 0 %} {% set heat = "bg-gray-900" %} {% elif count <=
            2 %} {% set heat = "bg-blue-900/40" %} {% elif count <= 5 %} {% set
            heat = "bg-orange-900/50" %} {% else %} {% set heat =
            "bg-red-900/60" %} {% endif %}

            <div
                class="day-cell {{ heat }} border border-gray-800 rounded-xl p-2 min-h-[110px] cursor-pointer"
                data-date="{{ date }}"
                onclick="openDay('{{ date }}')"
            >
                <div class="text-xs font-semibold mb-1">
                    {{ date[-2:] }} {% if date == today %}
                    <span class="ml-1 text-[10px] bg-blue-600 px-1.5 rounded"
                        >Today</span
                    >
                    {% endif %}
                </div>

                {% for v in visits[:3] %}
                <div class="truncate text-xs">{{ v.customer_name }}</div>
                {% endfor %} {% if count > 3 %}
                <div class="text-xs text-gray-400">+{{ count - 3 }} more</div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </section>
</div>

<!-- SIDE PANEL -->
<div
    id="side-panel"
    class="fixed top-0 right-0 h-full w-80 bg-gray-950 border-l border-gray-800 transform translate-x-full transition-transform z-50"
>
    <div class="p-4 border-b border-gray-800 flex justify-between items-center">
        <h3 class="font-semibold" id="panel-date">Route</h3>
        <button onclick="closePanel()" class="text-gray-400 hover:text-white">
            âœ•
        </button>
    </div>
    <div class="p-4 space-y-2" id="panel-content"></div>
</div>

<script>
    /* -------- View toggle -------- */
    const week = document.getElementById("week-view");
    const month = document.getElementById("month-view");
    document.querySelectorAll(".view-btn").forEach(btn => {
        btn.onclick = () => {
            document.querySelectorAll(".view-btn").forEach(b => b.classList.remove("bg-blue-600", "text-white"));
            btn.classList.add("bg-blue-600", "text-white");
            week.classList.toggle("hidden", btn.dataset.view !== "week");
            month.classList.toggle("hidden", btn.dataset.view !== "month");
        };
    });

    /* -------- Side panel -------- */
    function openDay(date) {
        const panel = document.getElementById("side-panel");
        const content = document.getElementById("panel-content");
        const visits = window.visitsByDate[date] || [];
        const order = getOrder(date, visits);

        document.getElementById("panel-date").textContent = date;
        content.innerHTML = order.map(v =>
            `<div class="bg-gray-900 border border-gray-800 rounded px-3 py-2 text-sm">${v.customer_name}</div>`
        ).join("");

        panel.classList.remove("translate-x-full");
    }

    function closePanel() {
        document.getElementById("side-panel").classList.add("translate-x-full");
    }

    /* -------- Persisted order -------- */
    function getOrder(date, visits) {
        const saved = localStorage.getItem("routeOrder:" + date);
        if (!saved) return visits;
        const ids = JSON.parse(saved);
        return ids.map(id => visits.find(v => v.customer_name === id)).filter(Boolean);
    }

    function optimizeDay(date) {
        const visits = window.visitsByDate[date];
        const shuffled = [...visits].sort(() => Math.random() - 0.5);
        localStorage.setItem(
            "routeOrder:" + date,
            JSON.stringify(shuffled.map(v => v.customer_name))
        );
        openDay(date);
    }

    /* -------- Inject visits map -------- */
    window.visitsByDate = {{ scheduled_visits | tojson }};
</script>

{% endblock %}
