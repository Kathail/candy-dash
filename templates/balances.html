{% extends "base.html" %} {% block title %}Balances - Candy Dash{% endblock %}
{% block content %}
<div class="max-w-7xl mx-auto space-y-10">
    <!-- Header â€“ exact same style as dashboard -->
    <header class="flex items-center justify-between">
        <div>
            <h1 class="text-3xl font-bold text-gray-200 mb-1">
                Outstanding Balances
            </h1>
            <p class="text-gray-400">Customers with unpaid invoices</p>
        </div>
        {% if customers %}
        <div
            class="text-sm text-gray-300 bg-gray-800/70 px-4 py-2 rounded-lg border border-gray-700"
        >
            {{ customers|length }} customer{{ 's' if customers|length != 1 else
            '' }} owing
        </div>
        {% endif %}
    </header>

    {% if customers %}

    <!-- KPI Cards â€“ exact same card style + hover as dashboard -->
    <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
        <div
            class="theme-card p-6 hover:border-app-accent transition-colors group"
        >
            <p class="text-sm text-gray-400 mb-2">Total Outstanding</p>
            <p id="stat-total" class="mt-2 text-3xl font-bold text-white">$â€”</p>
        </div>
        <div
            class="theme-card p-6 hover:border-app-danger transition-colors group"
        >
            <p class="text-sm text-gray-400 mb-2">Customers Owing</p>
            <p id="stat-count" class="mt-2 text-3xl font-bold text-white">â€”</p>
        </div>
        <div
            class="theme-card p-6 hover:border-app-warning transition-colors group"
        >
            <p class="text-sm text-gray-400 mb-2">Average Balance</p>
            <p id="stat-avg" class="mt-2 text-3xl font-bold text-app-accent">
                $â€”
            </p>
        </div>
        <div
            class="theme-card p-6 hover:border-app-danger transition-colors group"
        >
            <p class="text-sm text-gray-400 mb-2">High Risk ($100+)</p>
            <p id="stat-high" class="mt-2 text-3xl font-bold theme-text-danger">
                â€”
            </p>
        </div>
    </section>

    <!-- Bulk Actions â€“ same sticky bar style as customers page -->
    <div
        id="bulk-bar"
        class="hidden sticky top-4 z-20 theme-card px-6 py-4 shadow-lg flex flex-col sm:flex-row sm:items-center justify-between gap-4"
    >
        <span class="text-sm font-medium text-gray-300">
            <span id="selected-count" class="text-gray-200 font-bold">0</span>
            selected
        </span>
        <div class="flex flex-wrap gap-3">
            <button type="button" class="theme-btn-primary px-6 py-2.5">
                Add to Route
            </button>
            <button type="button" class="theme-btn-secondary px-6 py-2.5">
                Acknowledge
            </button>
            <button type="button" class="theme-btn-danger px-6 py-2.5">
                Delete Selected
            </button>
        </div>
    </div>

    <!-- Balances Table â€“ matches dashboard card feel -->
    <div class="theme-card overflow-hidden">
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-800 text-sm">
                <thead class="bg-gray-900/70 sticky top-0 z-10">
                    <tr
                        class="text-left text-xs font-semibold text-gray-300 uppercase tracking-wide"
                    >
                        <th class="px-6 py-5 w-12">
                            <input
                                type="checkbox"
                                id="select-all"
                                class="h-5 w-5 rounded border-gray-700 text-app-accent focus:ring-app-accent bg-gray-800"
                            />
                        </th>
                        <th class="px-6 py-5">Customer</th>
                        <th class="px-6 py-5 hidden md:table-cell">Phone</th>
                        <th class="px-6 py-5 text-right">Balance</th>
                        <th class="px-6 py-5 hidden sm:table-cell">
                            Last Visit
                        </th>
                        <th class="px-6 py-5 text-right">Payment</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-800">
                    {% for c in customers %} {% set balance = c.balance_cents /
                    100.0 %} {% set color_class = 'text-yellow-300' if balance <
                    20 else 'text-orange-400' if balance < 100 else
                    'theme-text-danger' %}
                    <tr class="hover:bg-gray-800/50 transition-colors">
                        <td class="px-6 py-5">
                            <input
                                type="checkbox"
                                class="row-check h-5 w-5 rounded border-gray-700 text-app-accent focus:ring-app-accent bg-gray-800"
                            />
                        </td>
                        <td class="px-6 py-5 font-medium text-gray-100">
                            {{ c.name }}
                        </td>
                        <td
                            class="px-6 py-5 text-gray-400 hidden md:table-cell"
                        >
                            {{ c.phone or "â€”" }}
                        </td>
                        <td
                            class="px-6 py-5 text-right font-semibold {{ color_class }}"
                            data-balance="{{ balance }}"
                        >
                            ${{ balance | round(2) }}
                        </td>
                        <td
                            class="px-6 py-5 text-gray-400 hidden sm:table-cell"
                        >
                            {% if c.last_visit_at %} {{
                            c.last_visit_at.strftime('%b %d, %Y') }} {% else %}
                            <span class="italic text-gray-500">Never</span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-5">
                            <form
                                method="post"
                                action="{{ url_for('balances.record_payment') }}"
                                class="flex items-center justify-end gap-3"
                            >
                                <input
                                    type="hidden"
                                    name="customer_id"
                                    value="{{ c.id }}"
                                />
                                <div class="relative w-32">
                                    <div
                                        class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"
                                    >
                                        <span class="text-gray-500 text-sm"
                                            >$</span
                                        >
                                    </div>
                                    <input
                                        type="number"
                                        step="0.01"
                                        min="0"
                                        name="amount"
                                        placeholder="{{ balance | round(2) }}"
                                        required
                                        class="theme-input pl-8 pr-3 text-right"
                                    />
                                </div>
                                <button
                                    type="submit"
                                    class="theme-btn-primary px-5 py-2 text-sm"
                                >
                                    Record
                                </button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    {% else %}

    <!-- Empty State â€“ matches dashboard empty feel -->
    <div class="theme-card p-12 text-center">
        <div class="text-5xl mb-6">ðŸŽ‰</div>
        <h2 class="text-xl font-semibold text-gray-200 mb-3">
            All balances cleared
        </h2>
        <p class="text-gray-400">
            No customers have outstanding payments right now.
        </p>
    </div>

    {% endif %}
</div>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        // Bulk selection
        const selectAll = document.getElementById("select-all");
        const rowChecks = document.querySelectorAll(".row-check");
        const bulkBar = document.getElementById("bulk-bar");
        const selectedCnt = document.getElementById("selected-count");

        function updateBulkUI() {
            const checked = [...rowChecks].filter((chk) => chk.checked).length;
            selectedCnt.textContent = checked;
            bulkBar.classList.toggle("hidden", checked === 0);

            if (selectAll) {
                const allChecked = [...rowChecks].every((chk) => chk.checked);
                const someChecked = [...rowChecks].some((chk) => chk.checked);
                selectAll.checked = allChecked;
                selectAll.indeterminate = someChecked && !allChecked;
            }
        }

        selectAll?.addEventListener("change", (e) => {
            rowChecks.forEach((chk) => (chk.checked = e.target.checked));
            updateBulkUI();
        });

        rowChecks.forEach((chk) =>
            chk.addEventListener("change", updateBulkUI),
        );

        // Stats calculation
        function updateStats() {
            const balances = [
                ...document.querySelectorAll("[data-balance]"),
            ].map((el) => parseFloat(el.dataset.balance) || 0);

            const total = balances.reduce((a, b) => a + b, 0);
            const count = balances.length;
            const highRisk = balances.filter((b) => b >= 100).length;
            const avg = count ? total / count : 0;

            document.getElementById("stat-total").textContent =
                "$" + total.toFixed(2);
            document.getElementById("stat-count").textContent = count;
            document.getElementById("stat-avg").textContent =
                "$" + avg.toFixed(2);
            document.getElementById("stat-high").textContent = highRisk;
        }

        updateStats();
    });
</script>
{% endblock %}
