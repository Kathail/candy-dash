{% extends "base.html" %} {% block title %}Balances{% endblock %} {% block
content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <!-- Header -->
    <header class="mb-8">
        <div class="flex items-center justify-between mb-2 flex-wrap gap-4">
            <div>
                <h2 class="text-3xl font-bold">Balances</h2>
                <p class="text-gray-400 mt-1">
                    Track outstanding balances and payment history
                </p>
            </div>
            <div class="flex gap-3">
                <button
                    onclick="exportBalances()"
                    class="bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition flex items-center gap-2"
                >
                    <svg
                        class="w-4 h-4"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                        />
                    </svg>
                    Export
                </button>
                <button
                    onclick="openRecordPaymentModal()"
                    class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition flex items-center gap-2"
                >
                    <svg
                        class="w-4 h-4"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M12 4v16m8-8H4"
                        />
                    </svg>
                    Record Payment
                </button>
            </div>
        </div>
    </header>

    <!-- Summary Cards -->
    <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <div
            class="bg-gray-900 border border-gray-800 rounded-2xl p-6 shadow-lg"
        >
            <div class="flex items-center justify-between mb-4">
                <h3
                    class="text-gray-400 text-sm font-medium uppercase tracking-wide"
                >
                    Total Outstanding
                </h3>
                <svg
                    class="w-5 h-5 text-red-500"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                    />
                </svg>
            </div>
            <p class="text-4xl font-bold text-red-400">
                ${{ (customers | selectattr('balance_cents', 'gt', 0) |
                sum(attribute='balance_cents') / 100) | round(2) }}
            </p>
            <p class="text-gray-500 text-sm mt-1">
                Across {{ customers | selectattr('balance_cents', 'gt', 0) |
                list | length }} customers
            </p>
        </div>

        <div
            class="bg-gray-900 border border-gray-800 rounded-2xl p-6 shadow-lg"
        >
            <div class="flex items-center justify-between mb-4">
                <h3
                    class="text-gray-400 text-sm font-medium uppercase tracking-wide"
                >
                    Overdue (30+ days)
                </h3>
                <svg
                    class="w-5 h-5 text-amber-500"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"
                    />
                </svg>
            </div>
            <p class="text-3xl font-bold text-amber-400">$0.00</p>
            <p class="text-gray-500 text-sm mt-1">0 customers</p>
        </div>

        <div
            class="bg-gray-900 border border-gray-800 rounded-2xl p-6 shadow-lg"
        >
            <div class="flex items-center justify-between mb-4">
                <h3
                    class="text-gray-400 text-sm font-medium uppercase tracking-wide"
                >
                    Collected This Week
                </h3>
                <svg
                    class="w-5 h-5 text-green-500"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
                    />
                </svg>
            </div>
            <p class="text-3xl font-bold text-green-400">$0.00</p>
            <p class="text-gray-500 text-sm mt-1">0 payments</p>
        </div>

        <div
            class="bg-gray-900 border border-gray-800 rounded-2xl p-6 shadow-lg"
        >
            <div class="flex items-center justify-between mb-4">
                <h3
                    class="text-gray-400 text-sm font-medium uppercase tracking-wide"
                >
                    Average Balance
                </h3>
                <svg
                    class="w-5 h-5 text-blue-500"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"
                    />
                </svg>
            </div>
            {% set owing = customers | selectattr('balance_cents', 'gt', 0) |
            list %}
            <p class="text-3xl font-bold text-blue-400">
                {% if owing %}${{ (owing | sum(attribute='balance_cents') /
                owing | length / 100) | round(2) }}{% else %}$0.00{% endif %}
            </p>
            <p class="text-gray-500 text-sm mt-1">Per customer owing</p>
        </div>
    </section>

    <!-- Filter Tabs + Search -->
    <div class="flex flex-wrap items-center gap-3 mb-6">
        <div class="flex gap-2 flex-wrap">
            <button
                onclick="filterBalances('all')"
                class="filter-tab active px-4 py-2 rounded-lg text-sm font-medium transition"
            >
                All
            </button>
            <button
                onclick="filterBalances('high')"
                class="filter-tab px-4 py-2 rounded-lg text-sm font-medium transition"
            >
                High ($100+)
            </button>
            <button
                onclick="filterBalances('overdue')"
                class="filter-tab px-4 py-2 rounded-lg text-sm font-medium transition"
            >
                Overdue
            </button>
            <button
                onclick="filterBalances('recent')"
                class="filter-tab px-4 py-2 rounded-lg text-sm font-medium transition"
            >
                Recent Activity
            </button>
        </div>
        <div class="ml-auto w-full sm:w-auto">
            <input
                type="text"
                id="balanceSearch"
                placeholder="Search customers..."
                class="bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 text-white text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 w-full sm:w-64"
                oninput="searchBalances()"
            />
        </div>
    </div>

    <!-- Balances List -->
    <section
        class="bg-gray-900 border border-gray-800 rounded-2xl overflow-hidden shadow-lg"
    >
        {% set owing_customers = customers | selectattr('balance_cents', 'gt',
        0) | list | sort(attribute='balance_cents', reverse=True) %} {% if
        owing_customers %}
        <div class="overflow-x-auto" id="balancesList">
            <table class="w-full">
                <thead class="bg-gray-950 border-b border-gray-800">
                    <tr>
                        <th
                            class="px-6 py-4 text-left text-xs font-semibold text-gray-400 uppercase tracking-wider cursor-pointer hover:text-blue-400 sortable"
                            onclick="sortTable('name')"
                        >
                            Customer <span class="sort-icon">â‡…</span>
                        </th>
                        <th
                            class="px-6 py-4 text-left text-xs font-semibold text-gray-400 uppercase tracking-wider"
                        >
                            Contact
                        </th>
                        <th
                            class="px-6 py-4 text-left text-xs font-semibold text-gray-400 uppercase tracking-wider cursor-pointer hover:text-blue-400 sortable"
                            onclick="sortTable('balance')"
                        >
                            Balance <span class="sort-icon">â‡…</span>
                        </th>
                        <th
                            class="px-6 py-4 text-left text-xs font-semibold text-gray-400 uppercase tracking-wider cursor-pointer hover:text-blue-400 sortable"
                            onclick="sortTable('lastVisit')"
                        >
                            Last Visit <span class="sort-icon">â‡…</span>
                        </th>
                        <th
                            class="px-6 py-4 text-left text-xs font-semibold text-gray-400 uppercase tracking-wider"
                        >
                            Status
                        </th>
                        <th
                            class="px-6 py-4 text-right text-xs font-semibold text-gray-400 uppercase tracking-wider"
                        >
                            Actions
                        </th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-800" id="balancesTableBody">
                    {% for c in owing_customers %}
                    <tr
                        class="hover:bg-gray-750 transition balance-row"
                        data-name="{{ c.name }}"
                        data-balance="{{ c.balance_cents }}"
                        data-last-visit="{{ c.last_visit_at.isoformat() if c.last_visit_at else '1900-01-01' }}"
                        data-phone="{{ c.phone or '' }}"
                        data-address="{{ c.address or '' }}"
                    >
                        <td class="px-6 py-4">
                            <div class="flex items-center gap-3">
                                <div
                                    class="w-10 h-10 bg-gradient-to-br from-blue-500 to-blue-600 rounded-full flex items-center justify-center text-white font-bold"
                                >
                                    {{ c.name[0].upper() }}
                                </div>
                                <div>
                                    <div class="font-medium text-white">
                                        {{ c.name }}
                                    </div>
                                    {% if c.address %}
                                    <div
                                        class="text-xs text-gray-500 truncate max-w-xs"
                                    >
                                        {{ c.address }}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4">
                            {% if c.phone %}
                            <a
                                href="tel:{{ c.phone }}"
                                class="text-blue-400 hover:text-blue-300 text-sm flex items-center gap-1"
                            >
                                <svg
                                    class="w-4 h-4"
                                    fill="none"
                                    stroke="currentColor"
                                    viewBox="0 0 24 24"
                                >
                                    <path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="2"
                                        d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"
                                    />
                                </svg>
                                {{ c.phone }}
                            </a>
                            {% else %}
                            <span class="text-gray-600 text-sm">â€”</span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4">
                            <div class="flex items-center gap-2">
                                <span class="text-lg font-bold text-red-400"
                                    >${{ (c.balance_cents / 100) | round(2)
                                    }}</span
                                >
                                {% if c.balance_cents >= 10000 %}
                                <span
                                    class="text-xs bg-red-500/20 text-red-400 px-2 py-1 rounded-full font-medium"
                                    >High</span
                                >
                                {% endif %}
                            </div>
                        </td>
                        <td class="px-6 py-4 text-gray-400 text-sm">
                            {% if c.last_visit_at %}
                            <div>
                                {{ c.last_visit_at.strftime('%b %d, %Y') }}
                            </div>
                            <div class="text-xs text-gray-600">
                                {% set days = (now.date() -
                                c.last_visit_at.date()).days %} {{ days }} day{{
                                's' if days != 1 }} ago
                            </div>
                            {% else %}
                            <span class="text-gray-600 text-sm"
                                >Never visited</span
                            >
                            {% endif %}
                        </td>
                        <td class="px-6 py-4">
                            {% set days_ago = (now.date() -
                            c.last_visit_at.date()).days if c.last_visit_at else
                            9999 %} {% if days_ago >= 30 %}
                            <span
                                class="inline-flex items-center gap-1 text-xs bg-red-500/20 text-red-400 px-2 py-1 rounded-full font-medium"
                            >
                                <svg
                                    class="w-3 h-3"
                                    fill="currentColor"
                                    viewBox="0 0 20 20"
                                >
                                    <path
                                        fill-rule="evenodd"
                                        d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z"
                                        clip-rule="evenodd"
                                    />
                                </svg>
                                Overdue
                            </span>
                            {% elif days_ago >= 14 %}
                            <span
                                class="inline-flex items-center gap-1 text-xs bg-amber-500/20 text-amber-400 px-2 py-1 rounded-full font-medium"
                            >
                                <svg
                                    class="w-3 h-3"
                                    fill="currentColor"
                                    viewBox="0 0 20 20"
                                >
                                    <path
                                        fill-rule="evenodd"
                                        d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z"
                                        clip-rule="evenodd"
                                    />
                                </svg>
                                Follow-up
                            </span>
                            {% else %}
                            <span
                                class="inline-flex items-center gap-1 text-xs bg-green-500/20 text-green-400 px-2 py-1 rounded-full font-medium"
                            >
                                <svg
                                    class="w-3 h-3"
                                    fill="currentColor"
                                    viewBox="0 0 20 20"
                                >
                                    <path
                                        fill-rule="evenodd"
                                        d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                                        clip-rule="evenodd"
                                    />
                                </svg>
                                Recent
                            </span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 text-right">
                            <button
                                onclick="openPaymentModal({{ c.id }}, '{{ c.name | e }}', {{ c.balance_cents }})"
                                class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition mr-2"
                            >
                                Record Payment
                            </button>
                            <a
                                href="{{ url_for('customers.customers') }}"
                                class="text-gray-400 hover:text-blue-400 transition"
                            >
                                <svg
                                    class="w-5 h-5 inline"
                                    fill="none"
                                    stroke="currentColor"
                                    viewBox="0 0 24 24"
                                >
                                    <path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="2"
                                        d="M15 12a3 3 0 11-6 0 3 3 0 016 0zM2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"
                                    />
                                </svg>
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="p-12 text-center text-gray-500">
            <div class="text-6xl mb-4">ðŸŽ‰</div>
            <h3 class="text-xl font-semibold mb-2 text-white">
                All Caught Up!
            </h3>
            <p class="mb-6">No outstanding balances. Great work!</p>
        </div>
        {% endif %} {% else %}
        <div class="p-12 text-center text-gray-500">
            <div class="text-6xl mb-4">ðŸ“Š</div>
            <h3 class="text-xl font-semibold mb-2 text-white">
                No Customers Yet
            </h3>
            <p class="mb-6">Add customers to start tracking balances</p>
            <a
                href="{{ url_for('customers.customers') }}"
                class="inline-block bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium transition"
            >
                Add Customers
            </a>
        </div>
        {% endif %}
    </section>
</div>

<!-- Record Payment Modal -->
<div
    id="paymentModal"
    class="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 hidden"
>
    <div
        class="bg-gray-900 border border-gray-700 rounded-2xl w-full max-w-md p-6"
    >
        <div class="flex items-center justify-between mb-6">
            <h3 class="text-xl font-semibold">Record Payment</h3>
            <button
                onclick="closePaymentModal()"
                class="text-gray-400 hover:text-white transition"
            >
                <svg
                    class="w-6 h-6"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M6 18L18 6M6 6l12 12"
                    />
                </svg>
            </button>
        </div>
        <form
            method="post"
            action="{{ url_for('balances.record_payment') }}"
            class="space-y-4"
        >
            <input type="hidden" id="paymentCustomerId" name="customer_id" />
            <div class="bg-gray-800 border border-gray-700 rounded-lg p-4">
                <div class="text-sm text-gray-400 mb-1">Customer</div>
                <div
                    class="text-lg font-semibold"
                    id="paymentCustomerName"
                ></div>
                <div class="text-sm text-red-400 mt-1">
                    Current balance:
                    <span id="paymentCurrentBalance" class="font-bold"></span>
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2"
                    >Payment Amount</label
                >
                <div class="relative">
                    <span
                        class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 font-bold"
                        >$</span
                    >
                    <input
                        type="number"
                        name="amount"
                        step="0.01"
                        min="0.01"
                        required
                        class="w-full bg-gray-800 border border-gray-700 rounded-lg pl-8 pr-4 py-3 text-white text-lg font-semibold focus:outline-none focus:ring-2 focus:ring-green-500"
                        placeholder="0.00"
                        id="paymentAmount"
                    />
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2"
                    >Payment Method</label
                >
                <select
                    name="payment_method"
                    class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-green-500"
                >
                    <option value="cash">Cash</option>
                    <option value="check">Check</option>
                    <option value="card">Card</option>
                    <option value="other">Other</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2"
                    >Notes (optional)</label
                >
                <textarea
                    name="notes"
                    rows="2"
                    class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-green-500 resize-none"
                    placeholder="Add any notes about this payment..."
                ></textarea>
            </div>
            <div class="flex gap-3 pt-2">
                <button
                    type="button"
                    onclick="closePaymentModal()"
                    class="flex-1 bg-gray-700 hover:bg-gray-600 text-white py-3 rounded-lg font-medium transition"
                >
                    Cancel
                </button>
                <button
                    type="submit"
                    class="flex-1 bg-green-600 hover:bg-green-700 text-white py-3 rounded-lg font-medium transition"
                >
                    Record Payment
                </button>
            </div>
        </form>
    </div>
</div>

<style>
    .filter-tab {
        background: transparent;
        color: #9ca3af;
        border: 1px solid transparent;
        transition: all 0.2s;
    }
    .filter-tab:hover {
        color: #e5e7eb;
        background: #374151;
        border-color: #4b5563;
    }
    .filter-tab.active {
        background: #3b82f6;
        color: white;
        border-color: #3b82f6;
    }
    .sort-icon {
        opacity: 0.3;
        font-size: 0.8em;
        margin-left: 0.25rem;
    }
    .sortable.asc .sort-icon::before {
        content: "â†‘";
        opacity: 1;
    }
    .sortable.desc .sort-icon::before {
        content: "â†“";
        opacity: 1;
    }
</style>

<script>
    let currentFilter = "all";

    function openPaymentModal(customerId, customerName, balanceCents) {
        document.getElementById("paymentCustomerId").value = customerId;
        document.getElementById("paymentCustomerName").textContent =
            customerName;
        document.getElementById("paymentCurrentBalance").textContent =
            "$" + (balanceCents / 100).toFixed(2);
        document.getElementById("paymentAmount").value = (
            balanceCents / 100
        ).toFixed(2);
        document.getElementById("paymentModal").classList.remove("hidden");
        document.getElementById("paymentAmount").focus();
    }

    function closePaymentModal() {
        document.getElementById("paymentModal").classList.add("hidden");
    }

    function openRecordPaymentModal() {
        alert("Select a customer from the list to record a payment");
    }

    function exportBalances() {
        alert("Export functionality coming soon! Will export to CSV.");
    }

    function filterBalances(filter) {
        currentFilter = filter;
        document
            .querySelectorAll(".filter-tab")
            .forEach((tab) => tab.classList.remove("active"));
        event.target.classList.add("active");

        document.querySelectorAll(".balance-row").forEach((row) => {
            const balance = parseInt(row.dataset.balance);
            const lastVisit = row.dataset.lastVisit;
            const daysSince =
                lastVisit !== "1900-01-01"
                    ? Math.floor(
                          (new Date() - new Date(lastVisit)) /
                              (1000 * 60 * 60 * 24),
                      )
                    : 9999;
            let show = true;

            switch (filter) {
                case "high":
                    show = balance >= 10000;
                    break;
                case "overdue":
                    show = daysSince >= 30;
                    break;
                case "recent":
                    show = daysSince <= 7;
                    break;
            }

            row.style.display = show ? "" : "none";
        });
    }

    function searchBalances() {
        const query = document
            .getElementById("balanceSearch")
            .value.toLowerCase();
        document.querySelectorAll(".balance-row").forEach((row) => {
            row.style.display = row.textContent.toLowerCase().includes(query)
                ? ""
                : "none";
        });
    }

    function sortTable(column) {
        const tbody = document.getElementById("balancesTableBody");
        const rows = Array.from(tbody.querySelectorAll(".balance-row"));

        const header = event.target.closest(".sortable");
        const isAsc = header.classList.contains("asc");
        const dir = isAsc ? "desc" : "asc";

        document
            .querySelectorAll(".sortable")
            .forEach((th) => th.classList.remove("asc", "desc"));
        header.classList.add(dir);

        rows.sort((a, b) => {
            let valA, valB;
            switch (column) {
                case "name":
                    valA = a.dataset.name.toLowerCase();
                    valB = b.dataset.name.toLowerCase();
                    break;
                case "balance":
                    valA = parseInt(a.dataset.balance);
                    valB = parseInt(b.dataset.balance);
                    break;
                case "lastVisit":
                    valA = a.dataset.lastVisit || "9999";
                    valB = b.dataset.lastVisit || "9999";
                    break;
            }
            if (typeof valA === "number")
                return dir === "asc" ? valA - valB : valB - valA;
            return dir === "asc"
                ? valA.localeCompare(valB)
                : valB.localeCompare(valA);
        });

        rows.forEach((row) => tbody.appendChild(row));
    }

    // Close modal on escape / outside click
    document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") closePaymentModal();
    });

    document.getElementById("paymentModal")?.addEventListener("click", (e) => {
        if (e.target.id === "paymentModal") closePaymentModal();
    });
</script>
{% endblock %}
