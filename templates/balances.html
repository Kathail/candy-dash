{% extends "base.html" %} {% block title %}Balances{% endblock %} {% block
content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 lg:py-10 space-y-8">
    <!-- Header -->
    <div
        class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4"
    >
        <div>
            <h1 class="text-2xl sm:text-3xl font-bold text-white">
                Outstanding Balances
            </h1>
            <p class="mt-1 text-sm text-gray-400">
                Customers with unpaid invoices
            </p>
        </div>
        {% if customers %}
        <div
            class="text-sm text-gray-300 bg-gray-800/70 px-4 py-2 rounded-lg border border-gray-700"
        >
            {{ customers|length }} customer{{ 's' if customers|length != 1 else
            '' }} owing
        </div>
        {% endif %}
    </div>

    {% if customers %}

    <!-- KPI Cards -->
    <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 lg:gap-6">
        <div
            class="bg-gray-800 border border-gray-700 rounded-xl p-5 shadow-sm"
        >
            <p
                class="text-xs font-medium text-gray-400 uppercase tracking-wide"
            >
                Total Outstanding
            </p>
            <p id="stat-total" class="mt-2 text-3xl font-bold text-white">$â€”</p>
        </div>
        <div
            class="bg-gray-800 border border-gray-700 rounded-xl p-5 shadow-sm"
        >
            <p
                class="text-xs font-medium text-gray-400 uppercase tracking-wide"
            >
                Customers Owing
            </p>
            <p id="stat-count" class="mt-2 text-3xl font-bold text-white">â€”</p>
        </div>
        <div
            class="bg-gray-800 border border-gray-700 rounded-xl p-5 shadow-sm"
        >
            <p
                class="text-xs font-medium text-gray-400 uppercase tracking-wide"
            >
                Average Balance
            </p>
            <p id="stat-avg" class="mt-2 text-3xl font-bold text-white">$â€”</p>
        </div>
        <div
            class="bg-gray-800 border border-gray-700 rounded-xl p-5 shadow-sm"
        >
            <p
                class="text-xs font-medium text-gray-400 uppercase tracking-wide"
            >
                High Risk ($100+)
            </p>
            <p id="stat-high" class="mt-2 text-3xl font-bold text-red-400">â€”</p>
        </div>
    </div>

    <!-- Bulk Actions Bar (sticky when scrolling) -->
    <div
        id="bulk-bar"
        class="hidden sticky top-4 z-20 bg-gray-950 border border-gray-700 rounded-xl px-5 py-3.5 shadow-lg flex flex-col sm:flex-row sm:items-center justify-between gap-4 transition-all duration-200"
    >
        <span class="text-sm text-gray-300 font-medium">
            <span id="selected-count" class="text-white">0</span> selected
        </span>
        <div class="flex flex-wrap gap-2">
            <button
                type="button"
                class="bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium px-4 py-2 rounded-lg transition"
            >
                Add to Route
            </button>
            <button
                type="button"
                class="bg-gray-700 hover:bg-gray-600 text-white text-sm font-medium px-4 py-2 rounded-lg transition"
            >
                Acknowledge
            </button>
            <button
                type="button"
                class="bg-red-600 hover:bg-red-700 text-white text-sm font-medium px-4 py-2 rounded-lg transition"
            >
                Delete
            </button>
        </div>
    </div>

    <!-- Table Container -->
    <div
        class="bg-gray-800 border border-gray-700 rounded-xl overflow-hidden shadow-sm"
    >
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-700 text-sm">
                <thead class="bg-gray-950 sticky top-0 z-10">
                    <tr
                        class="text-left text-gray-400 uppercase tracking-wide text-xs font-medium"
                    >
                        <th scope="col" class="px-4 py-4 w-10">
                            <input
                                type="checkbox"
                                id="select-all"
                                class="h-4 w-4 rounded border-gray-600 text-blue-500 focus:ring-blue-500 bg-gray-700"
                            />
                        </th>
                        <th scope="col" class="px-5 py-4">Customer</th>
                        <th scope="col" class="px-5 py-4 hidden md:table-cell">
                            Phone
                        </th>
                        <th scope="col" class="px-5 py-4">Balance</th>
                        <th scope="col" class="px-5 py-4 hidden sm:table-cell">
                            Last Visit
                        </th>
                        <th scope="col" class="px-5 py-4 text-right">
                            Payment
                        </th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-700">
                    {% for c in customers %} {% set balance = (c.balance_cents /
                    100.0) %} {% set color_class = 'text-yellow-300' if balance
                    < 20 else 'text-orange-400' if balance < 100 else
                    'text-red-400' %}
                    <tr
                        class="hover:bg-gray-700/60 transition-colors duration-150"
                    >
                        <td class="px-4 py-4">
                            <input
                                type="checkbox"
                                class="row-check h-4 w-4 rounded border-gray-600 text-blue-500 focus:ring-blue-500 bg-gray-700"
                            />
                        </td>
                        <td class="px-5 py-4 font-medium text-gray-100">
                            {{ c.name }}
                        </td>
                        <td
                            class="px-5 py-4 text-gray-400 hidden md:table-cell"
                        >
                            {{ c.phone or "â€”" }}
                        </td>
                        <td
                            class="px-5 py-4 font-semibold {{ color_class }}"
                            data-balance="{{ balance }}"
                        >
                            ${{ balance | round(2) }}
                        </td>
                        <td
                            class="px-5 py-4 text-gray-400 hidden sm:table-cell"
                        >
                            {% if c.last_visit_at %} {{
                            c.last_visit_at.strftime("%b %d, %Y") }} {% else %}
                            <span class="italic">Never</span>
                            {% endif %}
                        </td>
                        <td class="px-5 py-4">
                            <form
                                method="post"
                                action="{{ url_for('balances.record_payment') }}"
                                class="flex items-center justify-end gap-2"
                            >
                                <input
                                    type="hidden"
                                    name="customer_id"
                                    value="{{ c.id }}"
                                />
                                <div class="relative w-28">
                                    <div
                                        class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"
                                    >
                                        <span class="text-gray-500 text-sm"
                                            >$</span
                                        >
                                    </div>
                                    <input
                                        type="number"
                                        step="0.01"
                                        min="0"
                                        name="amount"
                                        placeholder="{{ balance | round(2) }}"
                                        required
                                        class="block w-full bg-gray-700 border border-gray-600 rounded-lg pl-8 pr-3 py-2 text-sm text-white placeholder-gray-500 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none transition"
                                    />
                                </div>
                                <button
                                    type="submit"
                                    class="bg-green-600 hover:bg-green-700 text-white text-sm font-medium px-4 py-2 rounded-lg transition"
                                >
                                    Record
                                </button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    {% else %}

    <!-- Empty State -->
    <div class="bg-gray-800 border border-gray-700 rounded-xl p-12 text-center">
        <div class="text-5xl mb-4">ðŸŽ‰</div>
        <h2 class="text-xl font-semibold text-white mb-2">
            All balances cleared
        </h2>
        <p class="text-gray-400">
            No customers have outstanding payments right now.
        </p>
    </div>

    {% endif %}
</div>

<script>
    // Bulk selection
    document.addEventListener("DOMContentLoaded", () => {
        const selectAll = document.getElementById("select-all");
        const rowChecks = document.querySelectorAll(".row-check");
        const bulkBar = document.getElementById("bulk-bar");
        const selectedCnt = document.getElementById("selected-count");

        function updateBulkUI() {
            const checkedCount = [...rowChecks].filter(
                (chk) => chk.checked,
            ).length;
            selectedCnt.textContent = checkedCount;
            bulkBar.classList.toggle("hidden", checkedCount === 0);
        }

        selectAll?.addEventListener("change", (e) => {
            rowChecks.forEach((chk) => (chk.checked = e.target.checked));
            updateBulkUI();
        });

        rowChecks.forEach((chk) =>
            chk.addEventListener("change", updateBulkUI),
        );

        // Stats
        function computeStats() {
            const balances = [
                ...document.querySelectorAll("[data-balance]"),
            ].map((el) => {
                return parseFloat(el.dataset.balance) || 0;
            });

            const total = balances.reduce((sum, v) => sum + v, 0);
            const count = balances.length;
            const high = balances.filter((v) => v >= 100).length;
            const average = count ? total / count : 0;

            document.getElementById("stat-total").textContent =
                "$" + total.toFixed(2);
            document.getElementById("stat-count").textContent = count;
            document.getElementById("stat-avg").textContent =
                "$" + average.toFixed(2);
            document.getElementById("stat-high").textContent = high;
        }

        computeStats();
    });
</script>
{% endblock %}
