{% extends "base.html" %} {% block title %}Balances{% endblock %} {% block
content %}

<div class="max-w-6xl mx-auto space-y-8">
    <!-- Header -->
    <header class="flex items-start justify-between">
        <div>
            <h1 class="text-3xl font-bold">Balances</h1>
            <p class="text-gray-400 mt-1">
                Track outstanding balances and payment history
            </p>
        </div>

        <div class="flex gap-3">
            <button type="button" data-action="export" class="btn-secondary">
                Export
            </button>

            <button
                type="button"
                data-action="record-payment"
                class="btn-primary"
            >
                Record Payment
            </button>
        </div>
    </header>

    <!-- Summary Cards -->
    {% set owing_customers = customers | selectattr('balance_cents', 'gt', 0) |
    list %} {% set total_outstanding = owing_customers |
    sum(attribute='balance_cents') %}

    <section class="grid grid-cols-1 md:grid-cols-4 gap-6">
        <!-- Total Outstanding -->
        <div class="card-highlight-red">
            <p class="card-label">Total Outstanding</p>
            <p class="card-value">
                ${{ (total_outstanding / 100) | round(2) }}
            </p>
            <p class="card-subtext">{{ owing_customers | length }} customers</p>
        </div>

        <!-- Overdue -->
        <div class="card-muted">
            <p class="card-label">Overdue (30+ days)</p>
            <p class="card-value text-amber-400">$0.00</p>
            <p class="card-subtext">0 customers</p>
        </div>

        <!-- Collected -->
        <div class="card-muted">
            <p class="card-label">Collected This Week</p>
            <p class="card-value text-green-400">$0.00</p>
            <p class="card-subtext">0 payments</p>
        </div>

        <!-- Average -->
        <div class="card-muted">
            <p class="card-label">Average Balance</p>
            <p class="card-value text-blue-400">
                {% if owing_customers %} ${{ ((total_outstanding /
                owing_customers|length) / 100) | round(2) }} {% else %} $0.00 {%
                endif %}
            </p>
            <p class="card-subtext">per customer</p>
        </div>
    </section>

    <!-- Controls -->
    <section class="flex flex-wrap gap-4 items-center">
        <input
            id="balance-search"
            type="search"
            placeholder="Search customers…"
            class="input w-full md:w-72"
        />

        <div class="flex gap-2">
            <button class="filter-tab active" data-filter="all">All</button>
            <button class="filter-tab" data-filter="high">High</button>
            <button class="filter-tab" data-filter="overdue">Overdue</button>
            <button class="filter-tab" data-filter="recent">Recent</button>
        </div>
    </section>

    <!-- Table -->
    <div class="bg-gray-900 border border-gray-800 rounded-xl overflow-hidden">
        <table class="w-full text-sm">
            <thead class="bg-gray-800 text-gray-300">
                <tr>
                    <th class="sortable" data-sort="name">Customer</th>
                    <th class="sortable text-right" data-sort="balance">
                        Balance
                    </th>
                    <th class="sortable" data-sort="lastVisit">Last Visit</th>
                    <th class="text-right">Actions</th>
                </tr>
            </thead>
            <tbody id="balances-body">
                {% for c in customers %}
                <tr
                    class="balance-row"
                    data-name="{{ c.name|lower }}"
                    data-balance="{{ c.balance_cents }}"
                    data-last-visit="{{ c.last_visit or '1900-01-01' }}"
                >
                    <td>{{ c.name }}</td>
                    <td class="text-right">
                        ${{ (c.balance_cents / 100) | round(2) }}
                    </td>
                    <td class="text-gray-400">{{ c.last_visit or '—' }}</td>
                    <td class="text-right">
                        {% if c.balance_cents > 0 %}
                        <button
                            class="text-green-400 hover:underline"
                            data-action="pay"
                            data-id="{{ c.id }}"
                            data-name="{{ c.name }}"
                            data-balance="{{ c.balance_cents }}"
                        >
                            Record Payment
                        </button>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Payment Modal -->
<div id="payment-modal" class="modal hidden">
    <div class="modal-card">
        <h3 class="text-xl font-bold mb-4">Record Payment</h3>

        <form id="payment-form">
            <input type="hidden" name="customer_id" />

            <div class="space-y-4">
                <div>
                    <p class="text-sm text-gray-400">Customer</p>
                    <p id="payment-name" class="font-medium"></p>
                </div>

                <div>
                    <label class="label">Amount</label>
                    <input
                        type="number"
                        step="0.01"
                        name="amount"
                        class="input"
                        required
                    />
                </div>

                <div>
                    <label class="label">Method</label>
                    <select name="method" class="input">
                        <option>Cash</option>
                        <option>Check</option>
                        <option>Card</option>
                        <option>Other</option>
                    </select>
                </div>

                <div>
                    <label class="label">Notes</label>
                    <textarea name="notes" rows="2" class="input"></textarea>
                </div>

                <div class="flex gap-3 pt-2">
                    <button
                        type="button"
                        class="btn-secondary"
                        data-action="close"
                    >
                        Cancel
                    </button>
                    <button type="submit" class="btn-primary">Record</button>
                </div>
            </div>
        </form>
    </div>
</div>

{% endblock %} {% block scripts %}
<script>
    (() => {
        const rows = [...document.querySelectorAll(".balance-row")];
        const search = document.getElementById("balance-search");
        const modal = document.getElementById("payment-modal");
        const form = document.getElementById("payment-form");

        let currentFilter = "all";
        let sort = { key: null, dir: 1 };

        const daysSince = (d) =>
            Math.floor((Date.now() - new Date(d)) / 86400000);

        function applyFilters() {
            const q = search.value.toLowerCase();

            rows.forEach((r) => {
                const bal = +r.dataset.balance;
                const days = daysSince(r.dataset.lastVisit);
                let show = r.dataset.name.includes(q);

                if (currentFilter === "high") show &&= bal >= 10000;
                if (currentFilter === "overdue") show &&= days >= 30;
                if (currentFilter === "recent") show &&= days <= 7;

                r.style.display = show ? "" : "none";
            });
        }

        document.querySelectorAll(".filter-tab").forEach((btn) => {
            btn.addEventListener("click", () => {
                document
                    .querySelector(".filter-tab.active")
                    ?.classList.remove("active");
                btn.classList.add("active");
                currentFilter = btn.dataset.filter;
                applyFilters();
            });
        });

        search.addEventListener("input", applyFilters);

        document.querySelectorAll("[data-sort]").forEach((th) => {
            th.addEventListener("click", () => {
                const key = th.dataset.sort;
                sort.dir = sort.key === key ? -sort.dir : 1;
                sort.key = key;

                rows.sort((a, b) => {
                    const A = a.dataset[key];
                    const B = b.dataset[key];
                    return A > B ? sort.dir : -sort.dir;
                });

                rows.forEach((r) => r.parentNode.appendChild(r));
            });
        });

        document.querySelectorAll('[data-action="pay"]').forEach((btn) => {
            btn.addEventListener("click", () => {
                form.customer_id.value = btn.dataset.id;
                document.getElementById("payment-name").textContent =
                    btn.dataset.name;
                form.amount.value = (btn.dataset.balance / 100).toFixed(2);
                modal.classList.remove("hidden");
            });
        });

        document
            .querySelectorAll('[data-action="close"]')
            .forEach((btn) =>
                btn.addEventListener("click", () =>
                    modal.classList.add("hidden"),
                ),
            );

        document.addEventListener("keydown", (e) => {
            if (e.key === "Escape") modal.classList.add("hidden");
        });
    })();
</script>
{% endblock %}
